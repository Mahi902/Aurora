<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mail</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        /* Base styles for a clean, simple look */
        body {
            background-color: #f0f2f5;
            font-family: 'Inter', sans-serif;
            margin: 0;
            color: #1a202c;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .mail-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
            position: relative;
            overflow: hidden;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .header h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        .user-code-container {
            background-color: #e2e8f0;
            padding: 8px 15px;
            border-radius: 10px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .user-code-container span {
            font-weight: 500;
            text-transform: uppercase;
        }

        .user-code-container i {
            cursor: pointer;
            color: #718096;
        }

        .user-code-container i:hover {
            color: #1a202c;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .tab-button {
            background-color: #e2e8f0;
            border: none;
            color: #1a202c;
            padding: 10px 15px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.2s;
        }
        
        .tab-button:hover {
            background-color: #cbd5e0;
        }
        
        .tab-button.active {
            background-color: #4299e1;
            color: #fff;
        }
        
        .mail-list {
            flex-grow: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding-right: 10px;
        }

        /* Scrollbar styles for mail list */
        .mail-list::-webkit-scrollbar { width: 8px; }
        .mail-list::-webkit-scrollbar-track { background: #f0f2f5; }
        .mail-list::-webkit-scrollbar-thumb { background-color: #e2e8f0; border-radius: 4px; }
        .mail-list::-webkit-scrollbar-thumb:hover { background-color: #cbd5e0; }
        
        .mail-item {
            background-color: #fff;
            padding: 15px;
            border-radius: 10px;
            cursor: pointer;
            transition: background-color 0.2s;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            position: relative;
        }
        
        .mail-item:hover {
            background-color: #f7fafc;
        }

        .mail-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .mail-from {
            font-weight: 600;
        }

        .mail-timestamp {
            font-size: 0.8rem;
            color: #718096;
        }
        
        .mail-subject {
            font-weight: 500;
            margin-bottom: 5px;
        }
        
        .mail-snippet {
            font-size: 0.9rem;
            color: #718096;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .mail-item-actions {
            position: absolute;
            top: 50%;
            right: 15px;
            transform: translateY(-50%);
            opacity: 0;
            transition: opacity 0.2s;
        }

        .mail-item:hover .mail-item-actions {
            opacity: 1;
        }

        .mail-item-actions i {
            cursor: pointer;
            color: #a0aec0;
            font-size: 1.2rem;
            transition: color 0.2s;
        }
        
        .mail-item-actions i:hover {
            color: #e53e3e;
        }

        .empty-state {
            text-align: center;
            color: #718096;
            margin-top: 50px;
        }

        /* Floating Action Button (FAB) */
        .fab-compose {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: #4299e1;
            color: #fff;
            border: none;
            font-size: 1.5rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: transform 0.2s, background-color 0.2s;
        }
        
        .fab-compose:hover {
            background-color: #3182ce;
            transform: scale(1.05);
        }

        /* Compose Mail Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
        }

        .modal.visible {
            opacity: 1;
            pointer-events: auto;
        }

        .modal-content {
            background-color: #fff;
            padding: 25px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            color: #1a202c;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            color: #1a202c;
            font-size: 1.5rem;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .modal-close:hover {
            opacity: 1;
        }

        .modal-field label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .modal-field input, .modal-field textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            background-color: #f7fafc;
            color: #1a202c;
            font-size: 1rem;
            resize: none;
        }
        
        .modal-field input:focus, .modal-field textarea:focus {
            outline: none;
            box-shadow: 0 0 0 2px #4299e1;
        }

        .modal-field textarea {
            min-height: 100px;
        }

        .send-button {
            background-color: #48bb78;
            color: #fff;
            padding: 12px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: background-color 0.2s;
        }

        .send-button:hover {
            background-color: #38a169;
        }

        /* Mail View Modal */
        #mailViewModal .modal-content {
            max-width: 600px;
            max-height: 90%;
            overflow-y: auto;
        }
        
        .mail-view-header {
            display: flex;
            flex-direction: column;
            gap: 5px;
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 15px;
            margin-bottom: 15px;
        }

        #viewMailSubject {
            font-size: 1.5rem;
            word-wrap: break-word;
        }

        .mail-view-details {
            font-size: 0.9rem;
            color: #718096;
        }

        .mail-view-content {
            white-space: pre-wrap;
            word-wrap: break-word;
            line-height: 1.6;
        }

        #viewMailContent {
            height: 200px;
            resize: vertical;
        }

        /* Message Box */
        .message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #4a5d71;
            color: #fff;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            z-index: 2000;
            display: none;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .message-box.visible {
            display: block;
            opacity: 1;
        }

        /* Responsive adjustments */
        @media (max-width: 600px) {
            .mail-container { padding: 10px; }
            .header { flex-direction: column; align-items: flex-start; gap: 10px; }
            .tabs { margin-bottom: 10px; }
            .tab-button { padding: 8px 12px; }
            .fab-compose { width: 50px; height: 50px; font-size: 1.2rem; }
            .modal-content { padding: 20px; }
        }
    </style>
</head>
<body>

<div class="mail-container">
    <div class="header">
        <h1>Mail</h1>
        <div class="user-code-container">
            <span>Your Code: <span id="userCodeDisplay">Loading...</span></span>
            <i class="fa-solid fa-copy" id="copyCodeButton" title="Copy code"></i>
        </div>
    </div>
    
    <div class="tabs">
        <button class="tab-button active" data-tab="all">All Mails</button>
        <button class="tab-button" data-tab="sent">Sent Mails</button>
    </div>
    
    <div class="mail-list" id="mailList">
        <div class="empty-state" id="loadingMessage">Loading mails...</div>
    </div>

    <!-- Compose Mail Modal -->
    <div class="modal" id="composeModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>New Mail</h2>
                <button class="modal-close" id="closeComposeModal">&times;</button>
            </div>
            <div class="modal-field">
                <label for="recipientCode">Recipient's Code</label>
                <input type="text" id="recipientCode" placeholder="Enter recipient's peer code">
            </div>
            <div class="modal-field">
                <label for="mailSubject">Subject (Optional)</label>
                <input type="text" id="mailSubject" placeholder="Enter subject">
            </div>
            <div class="modal-field">
                <label for="mailContent">Message</label>
                <textarea id="mailContent" placeholder="Your message here..."></textarea>
            </div>
            <button class="send-button" id="sendMailButton">Send</button>
        </div>
    </div>
    
    <!-- Mail View Modal -->
    <div class="modal" id="mailViewModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="viewMailHeader"></h2>
                <button class="modal-close" id="closeViewModal">&times;</button>
            </div>
            <div class="mail-view-header">
                <input type="text" id="viewMailSubject" placeholder="No Subject">
                <div id="viewMailFrom" class="mail-view-details"></div>
                <div id="viewMailTimestamp" class="mail-view-details"></div>
            </div>
            <div class="modal-field">
                <label for="viewMailContent">Message</label>
                <textarea id="viewMailContent" class="mail-view-content"></textarea>
            </div>
            <button class="send-button" id="saveMailButton">Save</button>
        </div>
    </div>

    <!-- Floating Action Button -->
    <button class="fab-compose" id="composeButton" title="Compose a new mail"><i class="fa-solid fa-plus"></i></button>

    <!-- Message Box -->
    <div id="messageBox" class="message-box"></div>

</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, where, addDoc, serverTimestamp, runTransaction, getDocs, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Global variables provided by the environment
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    const authToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const userCodeDisplay = document.getElementById('userCodeDisplay');
    const mailList = document.getElementById('mailList');
    const composeButton = document.getElementById('composeButton');
    const composeModal = document.getElementById('composeModal');
    const closeComposeModal = document.getElementById('closeComposeModal');
    const closeViewModal = document.getElementById('closeViewModal');
    const sendMailButton = document.getElementById('sendMailButton');
    const saveMailButton = document.getElementById('saveMailButton');
    const recipientCodeInput = document.getElementById('recipientCode');
    const mailSubjectInput = document.getElementById('mailSubject');
    const mailContentInput = document.getElementById('mailContent');
    const tabs = document.querySelectorAll('.tab-button');
    const messageBox = document.getElementById('messageBox');
    const copyCodeButton = document.getElementById('copyCodeButton');
    const loadingMessage = document.getElementById('loadingMessage');
    const mailViewModal = document.getElementById('mailViewModal');
    const viewMailSubject = document.getElementById('viewMailSubject');
    const viewMailFrom = document.getElementById('viewMailFrom');
    const viewMailTimestamp = document.getElementById('viewMailTimestamp');
    const viewMailContent = document.getElementById('viewMailContent');

    let userId = null;
    let userPeerCode = null;
    let currentMailId = null;

    function showMessage(message) {
        messageBox.textContent = message;
        messageBox.classList.add('visible');
        setTimeout(() => {
            messageBox.classList.remove('visible');
        }, 3000);
    }
    
    function formatTimestamp(timestamp) {
        if (!timestamp) return 'Just now';
        const date = timestamp.toDate();
        const now = new Date();
        const diffInSeconds = Math.floor((now - date) / 1000);
        const diffInMinutes = Math.floor(diffInSeconds / 60);
        const diffInHours = Math.floor(diffInMinutes / 60);
        const diffInDays = Math.floor(diffInHours / 24);

        if (diffInMinutes < 1) return 'Just now';
        if (diffInHours < 1) return `${diffInMinutes}m ago`;
        if (diffInDays < 1) return `${diffInHours}h ago`;
        
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }

    function renderMails(mails, tab) {
        mailList.innerHTML = '';
        if (mails.length === 0) {
            mailList.innerHTML = `<div class="empty-state">No mails in this folder.</div>`;
            return;
        }

        mails.sort((a, b) => b.timestamp - a.timestamp); // Sort by timestamp descending

        mails.forEach(mail => {
            const mailItem = document.createElement('div');
            mailItem.className = 'mail-item';

            const sender = tab === 'sent' ? `To: ${mail.recipient}` : `From: ${mail.sender}`;
            const subject = mail.subject || 'No Subject';
            const snippet = mail.content.slice(0, 50) + (mail.content.length > 50 ? '...' : '');

            mailItem.innerHTML = `
                <div class="mail-item-header">
                    <span class="mail-from">${sender}</span>
                    <span class="mail-timestamp">${formatTimestamp(mail.timestamp)}</span>
                </div>
                <div class="mail-subject">${subject}</div>
                <div class="mail-snippet">${snippet}</div>
                <div class="mail-item-actions">
                    <i class="fa-solid fa-trash-can delete-mail" data-mail-id="${mail.id}" title="Delete mail"></i>
                </div>
            `;
            mailItem.addEventListener('click', (e) => {
                if (e.target.classList.contains('delete-mail')) {
                    // Clicks on the trash icon are handled separately
                    return;
                }
                openMailView(mail);
            });
            mailList.appendChild(mailItem);

            mailItem.querySelector('.delete-mail').addEventListener('click', () => {
                deleteMail(mail.id);
            });
        });
    }

    function openMailView(mail) {
        currentMailId = mail.id;
        viewMailSubject.value = mail.subject || 'No Subject';
        const fromText = mail.sender === userPeerCode ? `To: ${mail.recipient}` : `From: ${mail.sender}`;
        viewMailFrom.textContent = fromText;
        viewMailTimestamp.textContent = formatTimestamp(mail.timestamp) || '';
        viewMailContent.value = mail.content;
        mailViewModal.classList.add('visible');
    }

    async function deleteMail(mailId) {
        try {
            const mailDocRef = doc(db, `artifacts/${appId}/users/${userId}/messages/${mailId}`);
            await deleteDoc(mailDocRef);
            showMessage('Mail deleted successfully!');
        } catch (e) {
            console.error("Error deleting document: ", e);
            showMessage('Failed to delete mail.');
        }
    }

    function generateUniquePeerCode() {
        return Math.random().toString(36).substring(2, 8).toUpperCase();
    }

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            userId = user.uid;
            
            const peerCodesRef = doc(db, `artifacts/${appId}/public/data/peer_codes/${userId}`);
            const peerCodeDoc = await getDoc(peerCodesRef);

            if (peerCodeDoc.exists()) {
                userPeerCode = peerCodeDoc.data().code;
            } else {
                let newCode = generateUniquePeerCode();
                let isCodeUnique = false;
                
                while (!isCodeUnique) {
                    const existingCodeQuery = query(collection(db, `artifacts/${appId}/public/data/peer_codes`), where('code', '==', newCode));
                    const existingCodeSnapshot = await getDocs(existingCodeQuery);
                    if (existingCodeSnapshot.empty) {
                        isCodeUnique = true;
                    } else {
                        newCode = generateUniquePeerCode();
                    }
                }
                userPeerCode = newCode;
                await setDoc(peerCodesRef, { userId: userId, code: userPeerCode });
            }
            userCodeDisplay.textContent = userPeerCode;
            if (loadingMessage) loadingMessage.remove();
            
            const privateMailCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/messages`);
            
            onSnapshot(privateMailCollectionRef, (snapshot) => {
                const allMails = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderMails(allMails, 'all');
                document.getElementById('mailList').dataset.currentTab = 'all';
                tabs.forEach(tab => tab.classList.remove('active'));
                document.querySelector('[data-tab="all"]').classList.add('active');
            });
            
            onSnapshot(query(privateMailCollectionRef, where('sender', '==', userPeerCode)), (snapshot) => {
                const sentMails = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (document.getElementById('mailList').dataset.currentTab === 'sent') {
                     renderMails(sentMails, 'sent');
                }
            });

        } else {
            if (authToken) {
                await signInWithCustomToken(auth, authToken);
            } else {
                await signInAnonymously(auth);
            }
        }
    });

    composeButton.addEventListener('click', () => {
        composeModal.classList.add('visible');
    });

    closeComposeModal.addEventListener('click', () => {
        composeModal.classList.remove('visible');
    });

    closeViewModal.addEventListener('click', () => {
        mailViewModal.classList.remove('visible');
    });

    sendMailButton.addEventListener('click', async () => {
        const recipientCode = recipientCodeInput.value.trim().toUpperCase();
        const subject = mailSubjectInput.value.trim();
        const content = mailContentInput.value.trim();

        if (!recipientCode || !content) {
            showMessage('Recipient code and message cannot be empty.');
            return;
        }

        const recipientPeerCodesQuery = query(collection(db, `artifacts/${appId}/public/data/peer_codes`), where('code', '==', recipientCode));
        const recipientSnapshot = await getDocs(recipientPeerCodesQuery);

        if (recipientSnapshot.empty) {
            showMessage('Recipient code not found.');
            return;
        }

        const recipientUserId = recipientSnapshot.docs[0].id;
        
        try {
            await runTransaction(db, async (transaction) => {
                const mail = {
                    sender: userPeerCode,
                    recipient: recipientCode,
                    subject: subject,
                    content: content,
                    timestamp: serverTimestamp()
                };

                const senderMailRef = doc(collection(db, `artifacts/${appId}/users/${userId}/messages`));
                transaction.set(senderMailRef, mail);

                const recipientMailRef = doc(collection(db, `artifacts/${appId}/users/${recipientUserId}/messages`));
                transaction.set(recipientMailRef, mail);
            });

            showMessage('Mail sent successfully!');
            composeModal.classList.remove('visible');
            recipientCodeInput.value = '';
            mailSubjectInput.value = '';
            mailContentInput.value = '';

        } catch (e) {
            console.error("Transaction failed: ", e);
            showMessage('Failed to send mail. Please try again.');
        }
    });

    saveMailButton.addEventListener('click', async () => {
        if (!currentMailId) {
            showMessage("No mail selected to save.");
            return;
        }
        
        const newSubject = viewMailSubject.value.trim();
        const newContent = viewMailContent.value.trim();
        
        if (!newContent) {
             showMessage("Message content cannot be empty.");
            return;
        }
        
        try {
            const mailDocRef = doc(db, `artifacts/${appId}/users/${userId}/messages/${currentMailId}`);
            await updateDoc(mailDocRef, {
                subject: newSubject,
                content: newContent
            });
            showMessage('Mail updated successfully!');
            mailViewModal.classList.remove('visible');
        } catch (e) {
            console.error("Error updating document: ", e);
            showMessage('Failed to update mail.');
        }
    });

    tabs.forEach(tab => {
        tab.addEventListener('click', (e) => {
            tabs.forEach(t => t.classList.remove('active'));
            e.target.classList.add('active');
            
            const currentTab = e.target.dataset.tab;
            document.getElementById('mailList').dataset.currentTab = currentTab;
            
            const mailCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/messages`);
            let q = mailCollectionRef;
            
            if (currentTab === 'all') {
                onSnapshot(q, (snapshot) => {
                    const mails = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderMails(mails, currentTab);
                });
            } else if (currentTab === 'sent') {
                onSnapshot(query(mailCollectionRef, where('sender', '==', userPeerCode)), (snapshot) => {
                    const mails = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderMails(mails, currentTab);
                });
            }
        });
    });

    copyCodeButton.addEventListener('click', () => {
        const textToCopy = userCodeDisplay.textContent;
        if (textToCopy && textToCopy !== 'Loading...') {
            const tempInput = document.createElement('input');
            tempInput.value = textToCopy;
            document.body.appendChild(tempInput);
            tempInput.select();
            document.execCommand('copy');
            document.body.removeChild(tempInput);
            showMessage('Code copied!');
        }
    });
</script>
</body>
</html>
