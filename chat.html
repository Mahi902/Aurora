<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chat | Anonymous P2P Chat</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>
  <script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <style>
    @keyframes fade-in {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate-fade-in {
      animation: fade-in 0.3s ease-out;
    }
    .scrollbar-hide::-webkit-scrollbar { display: none; }
    .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    .message-container:hover .message-hover { display: block; }
    .message-hover { 
      display: none; 
      position: absolute; 
      right: -80px; 
      top: 50%; 
      transform: translateY(-50%); 
      background: #f3f4f6;
      border: 1px solid #e5e7eb;
      padding: 8px 16px; 
      border-radius: 4px; 
      font-size: 14px; 
      white-space: nowrap; 
      color: #1f2937;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .user-details { 
      display: none; 
      position: absolute; 
      background: #f3f4f6;
      border: 1px solid #e5e7eb;
      padding: 10px; 
      border-radius: 5px; 
      z-index: 10; 
      box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
    }
    .avatar:hover .user-details { display: block; }
    .emoji-picker { 
      display: none; 
      position: absolute; 
      bottom: 60px; 
      right: 0; 
      background: #f3f4f6; 
      border: 1px solid #e5e7eb;
      padding: 10px; 
      border-radius: 5px; 
    }
    .user-profile-card {
      animation: slideIn 0.2s ease-out;
      max-width: 300px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
    }
    .user-profile-card img {
      object-fit: cover;
    }
    .user-profile-card button {
      transition: background-color 0.2s;
    }
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    .message-container.mentioned {
      background-color: #dbeafe;
      border-left: 3px solid #3b82f6;
      padding-left: 8px;
    }
    .message-container.mentioned .text-white {
      color: #1f2937;
    }
  </style>
</head>
<body class="bg-gray-100 h-screen font-sans">
  
  <!-- Main Application Wrapper -->
  <div class="flex h-full rounded-2xl overflow-hidden m-4 bg-white shadow-xl">

    <!-- Sidebar - Desktop only -->
    <aside class="hidden md:flex flex-col w-60 bg-white border-r border-gray-200 text-sm p-4">
      <div class="text-lg font-bold text-gray-900 tracking-wider">Chat</div>
      <div class="mt-4 p-2 text-xs uppercase text-gray-500 tracking-widest">Text Channels</div>
      <div class="px-4 py-2 bg-gray-100 text-gray-900 rounded-lg mx-2 my-1 cursor-pointer hover:bg-gray-200 transition-all duration-200">
        # direct
      </div>
      <div class="px-4 py-2 text-gray-600 mx-2 my-1 cursor-pointer hover:bg-gray-100 rounded-lg transition-all duration-200">
        
      </div>
      <div class="px-4 py-2 text-gray-600 mx-2 my-1 cursor-pointer hover:bg-gray-100 rounded-lg transition-all duration-200">
        
      </div>
      <div class="mt-auto p-4 flex items-center gap-2 border-t border-gray-200 cursor-pointer hover:bg-gray-100 rounded-lg transition-all duration-200" onclick="toggleProfilePanel()">
        <img id="avatar-preview" src="https://i.ibb.co.com/Cs3vDh96/360-F-553796090-XHr-E6-R9jwm-BJUMo9-HKl41hy-HJ5gqt9oz.jpg" class="w-10 h-10 rounded-full border-2 border-white" />
        <div>
          <div id="nickname-display" class="text-sm font-semibold text-gray-900">User #XXXX</div>
          <div class="text-xs text-green-600">Online</div>
        </div>
      </div>
      <div id="profile-panel" class="hidden absolute left-60 bottom-20 w-64 bg-white p-4 rounded-lg shadow-xl space-y-2 z-10 border border-gray-200">
        <label class="text-xs text-gray-600">Display Name</label>
        <input id="nickname-input" class="w-full p-2 rounded-lg bg-gray-100 text-gray-900 border border-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-400" />
        <label class="text-xs text-gray-600">Avatar</label>
        <input type="file" id="avatar-upload" accept="image/*" class="w-full text-gray-900 text-xs" />
        <button onclick="saveProfile()" class="w-full mt-2 bg-blue-500 hover:bg-blue-600 px-3 py-2 rounded-lg text-sm text-white transition-colors duration-200">Save</button>
      </div>
    </aside>

    <!-- Chat Section -->
    <div class="flex flex-col flex-1 bg-gray-50">
      <!-- Topbar -->
      <header class="h-16 flex items-center px-6 bg-white border-b border-gray-200 justify-between">
        <div class="text-gray-900 text-xl font-bold"># direct</div>
        <div class="flex items-center gap-4">
          <span id="current-peer-id" class="text-sm text-gray-600 mr-2"></span>
          <input id="peer-id-input" class="text-sm bg-gray-100 p-2 px-4 rounded-full placeholder:text-gray-500 text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="Enter a Peer ID"/>
          <button id="connect-btn" class="bg-blue-500 hover:bg-blue-600 text-sm px-4 py-2 rounded-full text-white shadow-lg transition-colors duration-200">Connect</button>
        </div>
      </header>

      <!-- Chat Window with Sidebar -->
      <div class="flex flex-1 overflow-hidden">
        <main id="chat-box" class="flex-1 overflow-y-auto p-6 space-y-4 scrollbar-hide text-sm">
          <div class="text-center text-gray-500 mt-20">
            <h2 class="text-3xl font-bold mb-2 text-gray-900">Welcome to Chat</h2>
            <p class="text-gray-600 text-sm">Start by adding people to your server!</p>
          </div>
        </main>
        
        <!-- Peer Sidebar -->
        <aside id="peer-sidebar" class="hidden md:flex flex-col w-60 bg-white p-4 overflow-y-auto scrollbar-hide border-l border-gray-200">
          <div id="peer-count" class="text-xs uppercase text-gray-900 tracking-widest">Connections - 0</div>
          <div id="peer-list" class="mt-2 space-y-2"></div>
        </aside>
      </div>

      <!-- Input Area -->
      <div id="reply-preview" class="hidden bg-gray-100 text-gray-900 text-sm px-4 py-2 border-l-4 border-blue-400 mx-4 mt-2 rounded-lg"></div>
      <footer class="h-16 px-6 flex items-center bg-white border-t border-gray-200 gap-3 relative">
        <input id="message-input" placeholder="Type your message..." class="flex-1 bg-gray-100 p-3 rounded-full text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-400 placeholder:text-gray-500" />
        <button id="emoji-btn" class="text-gray-600 hover:text-blue-500 text-xl transition-colors duration-200"><i class="fas fa-smile"></i></button>
        <emoji-picker id="emoji-picker" class="absolute bottom-16 right-4 z-50 hidden"></emoji-picker>
        <button id="send-btn" class="text-gray-600 hover:text-blue-500 text-xl transition-colors duration-200"><i class="fas fa-paper-plane"></i></button>
      </footer>
    </div>
  </div>

  <div id="mobile-sidebar" class="fixed inset-0 z-50 bg-white text-gray-900 p-4 transform -translate-x-full transition-transform duration-300 md:hidden">
    <button id="close-sidebar" class="mb-4 text-right text-gray-900 text-xl">
      <i class="fas fa-times"></i>
    </button>
    <div>
      <div class="text-sm font-semibold mb-2">Chat</div>
      <div class="text-xs uppercase text-gray-600 tracking-widest">Text Channels</div>
      <div class="py-1 mb-1 text-gray-900 font-semibold"># direct</div>
      <div class="py-1 text-gray-600"></div>
      <div class="py-1 text-gray-600"></div>
    </div>
    <hr class="my-4 border-gray-200"/>
    <div>
      <div class="text-xs uppercase tracking-widest text-gray-900">Online - <span id="mobile-peer-count">0</span></div>
      <div id="mobile-peer-list" class="space-y-2 mt-2"></div>
    </div>
  </div>

  <div id="connectivity-status-bar" class="fixed top-0 left-0 w-full p-2 text-center text-xs hidden z-50 transition-all duration-300 bg-gray-200">
    <span class="material-symbols-outlined mr-1 align-middle"></span>
    <span id="status-text" class="align-middle"></span>
  </div>

  <div id="peerchat-orientation-container" class="fixed top-0 left-0 w-full h-full bg-gray-900 bg-opacity-90 hidden z-50 flex-col items-center justify-center text-white">
    <span class="text-5xl mb-4 animate-spin"><i class="fas fa-mobile-alt"></i></span>
    <div class="text-xl font-semibold mb-2">Please rotate your device</div>
    <div class="text-sm text-gray-300">This application works best in landscape mode.</div>
    <a id="peerchat-sub-text" class="text-sm mt-4 text-blue-400 underline cursor-pointer">Continue anyway</a>
  </div>

  <script>
    // Self-contained JavaScript for the functionality.
    document.addEventListener('DOMContentLoaded', () => {
      const statusDiv = document.getElementById('connectivity-status-bar');
      const statusText = document.getElementById('status-text');
      const statusIcon = statusDiv.querySelector('.material-symbols-outlined');

      function showStatus(iconName, message, className) {
        statusIcon.textContent = iconName;
        statusText.textContent = message;
        statusDiv.className = `fixed top-0 left-0 w-full p-2 text-center text-xs z-50 transition-all duration-300 ${className}`;
        statusDiv.style.display = 'block';
      }

      function hideStatus() {
        statusDiv.style.display = 'none';
      }

      window.addEventListener('offline', () => {
        showStatus('cloud_off', 'Offline', 'bg-red-500 text-white');
      });

      window.addEventListener('online', () => {
        showStatus('cloud_done', 'Online', 'bg-green-500 text-white');
        setTimeout(hideStatus, 1000);
      });

      if (!navigator.onLine) {
        showStatus('cloud_off', 'Offline', 'bg-red-500 text-white');
      }
    });

    document.addEventListener('DOMContentLoaded', () => {
      const overlay = document.getElementById('peerchat-orientation-container');
      const continueLink = document.getElementById('peerchat-sub-text');

      if (window.innerWidth < window.innerHeight) {
        overlay.style.display = 'flex';
      }

      window.addEventListener('orientationchange', () => {
        if (window.innerWidth > window.innerHeight) {
          overlay.style.display = 'none';
        } else {
          overlay.style.display = 'flex';
        }
      });

      if (continueLink && overlay) {
        continueLink.addEventListener('click', (event) => {
          event.preventDefault();
          overlay.style.display = 'none';
        });
      }
    });

    const peer = new Peer();
    const connections = {};
    const chatBox = document.getElementById("chat-box");
    const messageInput = document.getElementById("message-input");
    const sendBtn = document.getElementById("send-btn");
    const peerList = document.getElementById("peer-list");
    const peerCount = document.getElementById("peer-count");
    const replyPreview = document.getElementById("reply-preview");
    const emojiBtn = document.getElementById("emoji-btn");
    const emojiPicker = document.getElementById("emoji-picker");
    const currentPeerId = document.getElementById("current-peer-id");
    const connectBtn = document.getElementById("connect-btn");
    const peerIdInput = document.getElementById("peer-id-input");
    const mobileMenuBtn = document.getElementById('mobile-menu-btn');
    const mobileSidebar = document.getElementById('mobile-sidebar');
    const closeSidebarBtn = document.getElementById('close-sidebar');

    let localUsername = `User #${Math.floor(1000 + Math.random() * 9000)}`;
    let localAvatar = document.getElementById("avatar-preview").src;
    let peerDetails = {};
    let replyingTo = null;

    peer.on("open", id => {
      alert(`All messages and content will be gone when all members disconnect. Your peer ID will change if you refresh or leave the chat. EVERYTHING IS LOST WHEN YOU LEAVE.`);
      showToast("End-to-end connection established <i class='fas fa-check text-green-400 ml-1'></i>");
      peerIdInput.placeholder = "Enter a peer ID"; 
      currentPeerId.textContent = `ID: ${id}`;
      peerDetails[id] = {
        joined: new Date(),
        messages: 0,
        files: 0,
        active: true,
        username: localUsername,
        avatar: localAvatar
      };
      const urlParams = new URLSearchParams(window.location.search);
      const remoteId = urlParams.get('id');
      if (remoteId) {
        const conn = peer.connect(remoteId);
        setupConnection(conn);
      }
    });

    peer.on("connection", conn => {
      setupConnection(conn);
    });

    connectBtn.onclick = () => {
      const id = peerIdInput.value.trim();
      if (id && !connections[id]) {
        const conn = peer.connect(id);
        setupConnection(conn);
      }
    };

    function setupConnection(conn) {
      connections[conn.peer] = conn;
      peerDetails[conn.peer] = {
        joined: new Date(),
        messages: 0,
        files: 0,
        active: true,
        username: conn.peer,
        avatar: "https://via.placeholder.com/40"
      };
      updatePeerSidebar();
      conn.on("open", () => {
        appendSystemMessage(`Connected to ${conn.peer}`);
        conn.send({ type: 'profile', username: localUsername, avatar: localAvatar });
      });
      conn.on("data", data => {
        if (data.type === 'profile') {
          peerDetails[conn.peer].username = data.username;
          peerDetails[conn.peer].avatar = data.avatar;
          updatePeerSidebar();
        } else {
          displayMessage(data.username, data.message, data.avatar, data.fileType, data.fileData, data.fileName, conn.peer, data.replyTo);
          peerDetails[conn.peer].messages++;
          if (data.fileType) peerDetails[conn.peer].files++;
          updatePeerSidebar();
        }
      });
      conn.on("close", () => {
        appendSystemMessage(`Disconnected: ${conn.peer}`);
        peerDetails[conn.peer].active = false;
        updatePeerSidebar();
        delete connections[conn.peer];
      });
    }

    function sendMessage() {
      const msg = messageInput.value.trim();
      if (!msg) return;
      const payload = { type: 'text', message: msg, replyTo: replyingTo };
      broadcast(payload);
      displayMessage(localUsername, msg, localAvatar, null, null, null, peer.id, replyingTo);
      messageInput.value = "";
      replyingTo = null;
      replyPreview.classList.add("hidden");
      peerDetails[peer.id].messages++;
      updatePeerSidebar();
    }

    sendBtn.onclick = sendMessage;
    messageInput.addEventListener("keypress", e => e.key === "Enter" && sendMessage());

    function broadcast(data) {
      Object.values(connections).forEach(conn => {
        if (conn.open) conn.send({ ...data, username: localUsername, avatar: localAvatar });
      });
    }

    function displayMessage(sender, message = '', avatar = '', fileType = '', fileData = '', fileName = '', peerId = null, replyTo = null) {
      const container = document.createElement("div");
      container.className = "message-container flex gap-3 relative group mb-2";
      container.dataset.peerId = peerId || peer.id;

      const img = document.createElement("img");
      img.src = avatar || "https://via.placeholder.com/40";
      img.className = "w-10 h-10 rounded-full avatar";
      img.dataset.peerId = peerId || peer.id;

      const content = document.createElement("div");
      content.className = "flex-1";

      if (replyTo) {
        const reply = document.createElement("div");
        reply.className = "text-xs text-gray-600 bg-gray-100 p-2 rounded-lg mb-1 border border-gray-200";
        reply.textContent = `Replying to ${replyTo.sender}: ${replyTo.message.slice(0, 20)}${replyTo.message.length > 20 ? '...' : ''}`;
        reply.addEventListener("click", () => {
          replyingTo = replyTo;
          messageInput.focus();
          updateReplyPreview();
        });
        content.appendChild(reply);
      }

      const messageWrapper = document.createElement("div");
      messageWrapper.className = "flex flex-col p-3 rounded-xl bg-gray-100 border border-gray-200 shadow-sm";

      const header = document.createElement("div");
      header.className = "flex items-center";
      header.innerHTML = `<span class="font-bold text-blue-500">${sender}</span> <span class="text-xs text-gray-500 ml-2">${new Date().toLocaleTimeString()}</span>`;

      const body = document.createElement("div");
      body.className = "text-gray-900 mt-2";

      const mentionRegex = new RegExp(`@${localUsername}\\b`, 'gi');
      const isMentioned = message.match(mentionRegex);
      if (isMentioned) {
        container.classList.add("mentioned");
      }

      if (message) {
        body.innerHTML = message.replace(mentionRegex, `<span class="bg-blue-300 text-blue-900 px-1 rounded">@${localUsername}</span>`);
      } else if (fileType && fileData) {
        let el;
        if (fileType.startsWith("image/")) {
          el = document.createElement("img");
          el.src = fileData;
          el.className = "w-64 rounded-xl mt-2 shadow-sm border border-gray-200";
        } else if (fileType.startsWith("video/")) {
          el = document.createElement("video");
          el.src = fileData;
          el.controls = true;
          el.className = "w-64 mt-2 shadow-sm rounded-xl border border-gray-200";
        } else if (fileType.startsWith("audio/")) {
          el = document.createElement("audio");
          el.src = fileData;
          el.controls = true;
          el.className = "mt-2";
        } else {
          const byteString = atob(fileData.split(',')[1]);
          const ab = new ArrayBuffer(byteString.length);
          const ia = new Uint8Array(ab);
          for (let i = 0; i < byteString.length; i++) {
            ia[i] = byteString.charCodeAt(i);
          }
          const blob = new Blob([ia], { type: fileType });
          const blobUrl = URL.createObjectURL(blob);
          const fileSizeKB = Math.round(blob.size / 1024);

          const embed = document.createElement("div");
          embed.className = "bg-white text-gray-900 p-3 rounded-lg mt-2 max-w-xs border border-gray-200 shadow-sm";

          const fileTitle = document.createElement("div");
          fileTitle.className = "font-semibold text-blue-500 break-all";
          fileTitle.textContent = fileName;

          const fileMeta = document.createElement("div");
          fileMeta.className = "text-xs text-gray-500 mt-1";
          fileMeta.textContent = `${fileType} â€¢ ${fileSizeKB} KB`;

          const actionLink = document.createElement("a");
          actionLink.href = blobUrl;
          actionLink.className = "text-blue-500 underline text-sm mt-2 inline-block";
          const previewTypes = [
            "application/pdf",
            "text/plain",
            "application/msword",
            "application/vnd.openxmlformats-officedocument.wordprocessingml.document"
          ];
          if (previewTypes.includes(fileType)) {
            actionLink.textContent = "Open in new tab";
            actionLink.target = "_blank";
          } else {
            actionLink.textContent = "Download";
            actionLink.download = fileName;
          }

          embed.appendChild(fileTitle);
          embed.appendChild(fileMeta);
          embed.appendChild(actionLink);
          el = embed;
        }
        body.appendChild(el);
      }

      messageWrapper.appendChild(header);
      messageWrapper.appendChild(body);
      content.appendChild(messageWrapper);

      const hover = document.createElement("div");
      hover.className = "message-hover";
      hover.innerHTML = '<i class="fas fa-reply text-blue-500 mr-2 cursor-pointer"></i><span class="text-gray-800">Reply</span>';
      hover.addEventListener("click", () => {
        const messageData = { sender, message, timestamp: new Date().toLocaleTimeString() };
        replyingTo = messageData;
        messageInput.focus();
        updateReplyPreview();
      });

      content.appendChild(hover);
      container.appendChild(img);
      container.appendChild(content);
      chatBox.appendChild(container);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    function appendSystemMessage(msg) {
      const div = document.createElement("div");
      div.className = "text-center text-gray-500 text-sm";
      div.textContent = msg;
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    function toggleProfilePanel() {
      const panel = document.getElementById("profile-panel");
      panel.classList.toggle("hidden");
      document.getElementById("nickname-input").value = localUsername;
    }

    function saveProfile() {
      const newName = document.getElementById("nickname-input").value.trim();
      if (newName) {
        localUsername = newName;
        document.getElementById("nickname-display").textContent = newName;
        broadcast({ type: 'profile', username: localUsername, avatar: localAvatar });
        peerDetails[peer.id].username = localUsername;
        updatePeerSidebar();
      }
      const file = document.getElementById("avatar-upload").files[0];
      if (file && file.type.startsWith("image/")) {
        const reader = new FileReader();
        reader.onload = () => {
          localAvatar = reader.result;
          document.getElementById("avatar-preview").src = localAvatar;
          broadcast({ type: 'profile', username: localUsername, avatar: localAvatar });
          peerDetails[peer.id].avatar = localAvatar;
          updatePeerSidebar();
        };
        reader.readAsDataURL(file);
      }
      document.getElementById("profile-panel").classList.add("hidden");
    }

    function updatePeerSidebar() {
      peerList.innerHTML = '';
      const activePeers = Object.values(peerDetails).filter(p => p.active).length;
      peerCount.textContent = `Online - ${activePeers}`;
      Object.keys(peerDetails).forEach(peerId => {
        const peer = document.createElement("div");
        peer.className = "flex items-center gap-2 p-1 hover:bg-gray-100 rounded-lg cursor-pointer transition-colors duration-200";
        peer.dataset.peerId = peerId;
        peer.innerHTML = `
          <img src="${peerDetails[peerId].avatar || 'https://via.placeholder.com/20'}" class="w-5 h-5 rounded-full" />
          <span class="text-gray-900 ml-auto">${peerDetails[peerId].username || peerId}</span>
          <span class="text-xs text-gray-500 ml-auto">${peerDetails[peerId].active ? 'Online' : 'Offline'}</span>
        `;
        peerList.appendChild(peer);
      });
      // Update mobile sidebar
      const mobilePeerList = document.getElementById("mobile-peer-list");
      const mobilePeerCount = document.getElementById("mobile-peer-count");
      mobilePeerList.innerHTML = peerList.innerHTML;
      mobilePeerCount.textContent = activePeers;
    }

    document.addEventListener("click", (e) => {
      document.querySelectorAll(".user-profile-card").forEach(el => el.remove());
      let avatar = e.target.closest(".avatar");
      if (!avatar) avatar = e.target.closest("[data-peer-id]");
      if (avatar) {
        const peerId = avatar.dataset.peerId;
        if (peerDetails[peerId]) {
          const joined = Math.floor((new Date() - peerDetails[peerId].joined) / 1000 / 60) + 'm ago';
          
          const profileCard = document.createElement("div");
          profileCard.className = "user-profile-card fixed bg-white text-gray-900 rounded-lg shadow-xl p-4 w-64 z-50 border border-gray-200";
          
          const rect = avatar.getBoundingClientRect();
          profileCard.style.left = `${rect.right + 10}px`;
          profileCard.style.top = `${rect.top - 50}px`;

          const cardRect = profileCard.getBoundingClientRect();
          if (cardRect.right > window.innerWidth) {
            profileCard.style.left = `${rect.left - cardRect.width - 10}px`;
          }
          if (cardRect.top < 0) {
            profileCard.style.top = `${rect.top + 10}px`;
          }

          profileCard.innerHTML = `
            <div class="flex items-center gap-3 mb-3">
              <img src="${peerDetails[peerId].avatar || 'https://via.placeholder.com/40'}" class="w-12 h-12 rounded-full border border-gray-200" />
              <div>
                <h3 class="text-lg font-bold">${peerDetails[peerId].username || peerId}</h3>
                <p class="text-xs text-gray-600">ID: ${peerId}</p>
              </div>
            </div>
            <hr class="border-gray-200 mb-3">
            <p class="text-sm text-gray-700">Messages: ${peerDetails[peerId].messages}</p>
            <p class="text-sm text-gray-700">Files: ${peerDetails[peerId].files}</p>
            <p class="text-sm text-gray-700">Joined: ${joined}</p>
            <p class="text-sm text-gray-700">Status: ${peerDetails[peerId].active ? 'Connected' : 'Disconnected'}</p>
            <button class="mt-3 w-full bg-blue-500 hover:bg-blue-600 text-white py-2 rounded-lg text-sm shadow-sm transition-colors duration-200">Mention @</button>
          `;
          document.body.appendChild(profileCard);
          profileCard.querySelector("button").addEventListener("click", () => {
            messageInput.value += `@${peerDetails[peerId].username} `;
            messageInput.focus();
            profileCard.remove();
          });
          const closeCard = (event) => {
            if (!profileCard.contains(event.target) && event.target !== avatar) {
              profileCard.remove();
              document.removeEventListener("click", closeCard);
            }
          };
          setTimeout(() => {
            document.addEventListener("click", closeCard);
          }, 0);
        }
      }
    });

    function updateReplyPreview() {
      if (replyingTo) {
        replyPreview.textContent = `Replying to ${replyingTo.sender}: ${replyingTo.message.slice(0, 30)}${replyingTo.message.length > 30 ? '...' : ''}`;
        replyPreview.classList.remove("hidden");
      } else {
        replyPreview.classList.add("hidden");
      }
    }

    emojiBtn.addEventListener("click", () => {
      emojiPicker.classList.toggle("hidden");
    });

    emojiPicker.addEventListener("emoji-click", event => {
      const emoji = event.detail.unicode;
      messageInput.value += emoji;
      messageInput.focus();
    });

    function showToast(message) {
      const toast = document.createElement("div");
      toast.innerHTML = message;
      toast.className = "fixed bottom-4 right-4 bg-blue-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 animate-fade-in";
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }
  </script>
</body>
</html>
