<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aurora Launcher 2.1</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Font Awesome for application icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <!-- Load Google Material Symbols for system icons (Settings, Lock, Status, etc.) -->
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- Base & Custom Variables --- */
        :root {
            --bar-blur: 15px;
            --bar-background: rgba(255, 255, 255, 0.4);
            --menu-background: rgba(255, 255, 255, 0.85);
            --text-color: #1a1a1a;
            --hover-background: rgba(255, 255, 255, 0.7);
            --accent-color: #4f46e5;
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        /* Set Inter font globally */
        body { font-family: 'Inter', sans-serif; }

        /* --- Global Background (Desktop) --- */
        #desktop-container {
            width: 100vw;
            height: 100vh;
            background-size: cover;
            background-position: center;
            transition: background-image 0.5s ease;
            position: relative;
            overflow: hidden;
        }

        /* --- Lock Screen Specific Styles --- */
        #lock-screen {
            transition: all 0.5s ease;
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: 50; 
            align-items: center;
            justify-content: center;
            flex-direction: column;
            color: white;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
            overflow: hidden; 
        }
        
        /* Layer for the heavily blurred background image */
        #lock-background-blur {
            position: absolute;
            top: -30px; 
            left: -30px;
            right: -30px;
            bottom: -30px;
            background-size: cover;
            background-position: center;
            z-index: 0; 
            filter: blur(30px); 
            transition: background-image 0.5s ease, filter 0.5s ease;
        }

        /* --- Taskbar & Menu Blur/Glassmorphism --- */
        .glass-bar {
            backdrop-filter: blur(var(--bar-blur));
            background-color: var(--bar-background);
            box-shadow: var(--shadow-lg);
        }

        /* --- Start Menu & Window Blur --- */
        .glass-menu {
            backdrop-filter: blur(25px);
            background-color: var(--menu-background);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        /* --- Scrollbar Style (Webkit) --- */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb {
            background-color: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
        }

        /* --- Taskbar Position Handling (Top/Bottom) --- */
        #taskbar-container.taskbar-top {
            top: 0; bottom: auto;
            border-bottom: 1px solid rgba(255, 255, 255, 0.5);
        }
        #taskbar-container.taskbar-bottom {
            top: auto; bottom: 0;
            border-top: 1px solid rgba(255, 255, 255, 0.5);
        }
        
        /* Resize handle for windows */
        .resize {
            min-width: 300px;
            min-height: 200px;
            resize: both;
        }

        .fullscreen-window {
            border-radius: 0 !important;
        }

        /* --- Custom Context Menu Styles --- */
        #context-menu {
            position: absolute;
            z-index: 100;
            min-width: 180px;
            padding: 8px;
        }
        .context-item {
            padding: 8px 12px;
            cursor: pointer;
            transition: all 0.15s ease;
        }
        .context-item:hover {
            background-color: var(--accent-color);
            color: white;
            border-radius: 4px;
        }
        
        /* Notification style */
        #notification-box {
            top: 10px;
            right: 10px;
            z-index: 60;
            max-width: 300px;
        }

        /* Sidebar content container for proper flex/scroll behavior */
        /* Flex grow is used to ensure it takes up all available space for scrolling */
        #sidebar-content-wrapper {
            flex-grow: 1; 
            overflow-y: auto;
        }

    </style>
</head>

<body class="bg-gray-100 overflow-hidden" oncontextmenu="return false;">

    <!-- 1. LOCK SCREEN (Layered for Blurred Background) -->
    <!-- Lock screen is hidden by default to prevent flash of content -->
    <div id="lock-screen" class="hidden" style="background-color: rgba(0,0,0,0.5);">
        <!-- Blurred Background Layer -->
        <div id="lock-background-blur"></div>
        
        <!-- Foreground Content Layer -->
        <div class="relative z-10 flex flex-col items-center justify-center h-full w-full p-4">
            <h1 class="text-6xl font-extralight mb-4" id="lock-time"></h1>
            <p class="text-xl mb-12" id="lock-date"></p>
            <div class="glass-bar p-8 rounded-xl flex flex-col items-center max-w-sm w-full">
                <img id="lock-pfp" class="w-20 h-20 rounded-full mb-4 border-4 border-white shadow-lg object-cover" src="https://placehold.co/100x100/4f46e5/ffffff?text=U" alt="Profile Picture">
                <p class="text-xl font-semibold mb-2 text-gray-900" id="lock-username">User</p>
                <form id="unlock-form" class="w-full">
                    <input id="password-input" type="password" placeholder="Enter Password" class="w-full p-3 mb-4 rounded-lg bg-white bg-opacity-70 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 text-gray-800 placeholder-gray-500 shadow-md" required>
                    <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-3 rounded-lg transition duration-200 shadow-xl">Unlock</button>
                    <p id="unlock-error" class="text-red-500 font-medium mt-2 hidden text-center"></p>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Custom Notification Box -->
    <div id="notification-box" class="fixed hidden transition-all duration-300 transform translate-x-full">
        <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded-lg shadow-xl" role="alert">
            <p id="notification-title" class="font-bold"></p>
            <p id="notification-message"></p>
        </div>
    </div>


    <!-- 2. DESKTOP CONTAINER -->
    <div id="desktop-container">

        <!-- Desktop Icons Area -->
        <div id="desktop-icons" class="p-4 pt-12 absolute inset-0 pb-16">
            <!-- Icons will be rendered here dynamically -->
        </div>

        <!-- Start Menu -->
        <div id="start-menu" class="glass-menu rounded-xl transition-all duration-300 ease-in-out transform scale-95 opacity-0 pointer-events-none absolute bottom-16 left-4 w-[600px] h-[500px] z-40 flex shadow-2xl">
            <!-- Left Side: All Apps List -->
            <div class="w-1/2 p-4 border-r border-gray-300 overflow-y-auto">
                <h3 class="text-lg font-bold mb-3">All Apps</h3>
                <div id="all-apps-list" class="space-y-1">
                    <!-- App buttons injected here -->
                </div>
            </div>

            <!-- Right Side: Pinned & User Actions -->
            <div class="w-1/2 p-4 flex flex-col justify-between">
                <div>
                    <h3 class="text-lg font-bold mb-3">Pinned</h3>
                    <div id="pinned-apps-list" class="grid grid-cols-3 gap-3">
                        <!-- Pinned apps injected here -->
                    </div>
                </div>

                <!-- Bottom: System/User Actions -->
                <div class="border-t border-gray-300 pt-4">
                    <div class="flex items-center space-x-3 mb-4 p-2 rounded-lg bg-gray-200 hover:bg-gray-300 cursor-pointer">
                         <img id="menu-pfp" class="w-8 h-8 rounded-full border border-gray-400 object-cover" src="https://placehold.co/100x100/4f46e5/ffffff?text=U" alt="User PFP">
                        <span id="menu-username" class="font-semibold text-sm">User</span>
                    </div>

                    <div class="flex justify-between">
                        <!-- Settings Button (using Material Icon for consistency with system buttons) -->
                        <button onclick="openApp('settings')" class="flex flex-col items-center p-2 rounded-lg hover:bg-gray-200 transition duration-150">
                            <span class="material-symbols-outlined fill-0 text-2xl text-gray-700">settings</span>
                            <span class="text-xs mt-1 text-gray-700">Settings</span>
                        </button>
                        <!-- Logout/Lock Button -->
                        <button onclick="lockScreen()" class="flex flex-col items-center p-2 rounded-lg hover:bg-gray-200 transition duration-150">
                            <span class="material-symbols-outlined fill-0 text-2xl text-red-500">lock</span>
                            <span class="text-xs mt-1 text-red-500">Lock</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Application Windows Container -->
        <div id="app-windows">
            <!-- Application windows will be injected here -->
        </div>

        <!-- 3. TASKBAR (Bottom/Top, dynamically positioned) -->
        <!-- Added opacity and pointer-events classes for smooth hiding/showing on lock screen -->
        <div id="taskbar-container" class="glass-bar fixed left-0 right-0 h-12 flex justify-between items-center px-4 z-50 transition-all duration-300 taskbar-bottom">
            <div class="flex items-center space-x-2">
                <!-- Start Button (Aurora Icon - Material Symbol) -->
                <button id="start-button" class="flex items-center justify-center w-8 h-8 rounded-full hover:bg-white/50 transition duration-150">
                    <span class="material-symbols-outlined fill-1 text-2xl text-indigo-700">flare</span>
                </button>

                <!-- Pinned/Running Apps (Taskbar) -->
                <div id="taskbar-apps" class="flex items-center space-x-1">
                    <!-- Taskbar app icons injected here -->
                </div>
            </div>

            <!-- Clock and Status (Right Side) -->
            <div class="flex items-center space-x-3">
                <span id="taskbar-time" class="text-sm font-medium"></span>
                <button id="status-button" class="flex items-center justify-center w-8 h-8 rounded-full hover:bg-white/50 transition duration-150">
                    <span class="material-symbols-outlined fill-0 text-xl">keyboard_arrow_left</span>
                </button>
            </div>
        </div>

        <!-- Right Clock/Status Sidebar (Updated structure) -->
        <div id="time-sidebar" class="glass-menu fixed right-0 top-0 h-full w-80 translate-x-full transition-transform duration-300 ease-in-out p-6 pt-6 z-40 border-l border-gray-300 flex flex-col">
            
            <!-- 3a. Time, Date, Day, Month, Year (Always visible at top) -->
            <div id="sidebar-time-date-display" class="mb-6 pb-4 border-b border-gray-300">
                <!-- Content injected by JS -->
            </div>
            
            <!-- 3b. Scrollable Content Area -->
            <!-- The flex-grow and overflow-y-auto classes are moved here to enable scrolling -->
            <div id="sidebar-content-wrapper" class="flex-grow overflow-y-auto pr-2">
                <h3 class="text-lg font-bold mb-3 text-indigo-700">Quick Settings</h3>
                <div class="grid grid-cols-2 gap-3 mb-6">
                    <!-- Toggle Taskbar Position -->
                    <button onclick="toggleTaskbarPosition()" class="p-3 bg-indigo-100 rounded-lg hover:bg-indigo-200 transition duration-150 flex flex-col items-center justify-center space-y-1 text-indigo-800">
                        <span class="material-symbols-outlined text-xl">swap_vert</span>
                        <span class="text-xs font-medium">Taskbar Pos</span>
                    </button>
                    <!-- Test Notification -->
                    <button onclick="showNotification('System Info', 'Aurora Launcher 2.1. Running latest version. Optimized for landscape devices. Developed by DocuWrite Pro. BETA.')" class="p-3 bg-yellow-100 rounded-lg hover:bg-yellow-200 transition duration-150 flex flex-col items-center justify-center space-y-1 text-yellow-800">
                        <span class="material-symbols-outlined text-xl">notifications</span>
                        <span class="text-xs font-medium">System Info</span>
                    </button>
                    <!-- More settings go here... -->
                </div>

                <h3 class="text-lg font-bold mb-3 text-gray-700">System Information</h3>
                <p class="text-sm text-gray-600 p-2 bg-white rounded-lg shadow-sm">Aurora Launcher 2.1 (Fluid Release) running on Canvas OS.</p>
                <p class="text-sm text-gray-600 p-2 bg-white rounded-lg shadow-sm mt-2">Developed by DocuWrite Pro.</p>
            </div>

            <!-- 3c. Device Status (Always visible at bottom) -->
            <div class="border-t border-gray-300 pt-4 mt-auto">
                <h3 class="text-lg font-bold mb-3 text-gray-800">Device Status</h3>
                <div class="space-y-3">
                    <div class="flex items-center space-x-3">
                        <span class="material-symbols-outlined fill-0 text-2xl text-green-600">check_circle</span>
                        <p class="font-medium text-sm">All systems operational.</p>
                    </div>
                    <div class="flex items-center space-x-3">
                        <span class="material-symbols-outlined fill-0 text-2xl text-blue-600">signal_cellular_alt</span>
                        <p class="font-medium text-sm">Network: Connected</p>
                    </div>
                    
                </div>
            </div>
        </div>

        <!-- Right-Click Context Menu -->
        <div id="context-menu" class="glass-menu rounded-lg p-1 hidden shadow-xl" oncontextmenu="return false;">
            <div id="context-add-desktop" class="context-item flex items-center space-x-2">
                <span class="material-symbols-outlined text-base">desktop_windows</span>
                <span>Add to Desktop</span>
            </div>
            <div id="context-remove-desktop" class="context-item hidden flex items-center space-x-2">
                <span class="material-symbols-outlined text-base">close</span>
                <span>Remove from Desktop</span>
            </div>
            <hr class="my-1 border-gray-300">
            <div id="context-pin-start" class="context-item flex items-center space-x-2">
                <span class="material-symbols-outlined text-base">push_pin</span>
                <span>Pin to Start</span>
            </div>
            <div id="context-unpin-start" class="context-item hidden flex items-center space-x-2">
                <span class="material-symbols-outlined text-base">push_pin</span>
                <span>Unpin from Start</span>
            </div>
            <hr class="my-1 border-gray-300">
            <div id="context-open-app" class="context-item flex items-center space-x-2">
                <span class="material-symbols-outlined text-base">open_in_new</span>
                <span>Open</span>
            </div>
        </div>

        <!-- Custom Confirmation Modal -->
        <div id="custom-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-[100] items-center justify-center">
            <div class="bg-white p-6 rounded-xl shadow-2xl w-96">
                <h3 id="modal-title" class="text-xl font-bold mb-3"></h3>
                <p id="modal-message" class="mb-5 text-gray-700"></p>
                <div class="flex justify-end space-x-3">
                    <button id="modal-cancel" class="px-4 py-2 text-gray-600 rounded-lg hover:bg-gray-100 transition duration-150">Cancel</button>
                    <button id="modal-confirm" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition duration-150">Confirm</button>
                </div>
            </div>
        </div>
    </div>


    <script>
        // --- Globals & Initial Setup ---
        const DEFAULT_WALLPAPER = "https://i.ibb.co.com/B5pN22gn/IMG-20250929-153706.png";
        const DEFAULT_PFP = "https://placehold.co/100x100/4f46e5/ffffff?text=U";
        const DEFAULT_PASSWORD_HASH = '1234'; 
        const STORAGE_KEY = 'auroraLauncherData';
        const FIRST_RUN_KEY = 'auroraLauncherFirstRun'; 

        // User-provided app list (updated with correct source URLs)
        const USER_APPS_ARRAY = [
    { id: 'ai', name: 'Artificial Intelligence', icon: 'fa-solid fa-robot', color: '#85C1E9', sourceUrl: 'https://mahi902.github.io/Aurora/ai.html' },
    { id: 'browser', name: 'Browser', icon: 'fa-solid fa-globe', color: '#5DADE2', sourceUrl: 'https://mahi902.github.io/Aurora/search.html' },
    { id: 'calendar', name: 'Calendar', icon: 'fa-solid fa-calendar', color: '#3498DB', sourceUrl: 'https://mahi902.github.io/Aurora/calendar.html' },
    { id: 'calculator', name: 'Calculator', icon: 'fa-solid fa-calculator', color: '#1F618D', sourceUrl: 'https://mahi902.github.io/Aurora/calculator.html' }, 
    { id: 'camera', name: 'Camera', icon: 'fa-solid fa-camera', color: '#2874A6', sourceUrl: 'https://mahi902.github.io/Aurora/camera.html' }, 
    { id: 'mail', name: 'Chat', icon: 'fa-solid fa-message', color: '#2E86C1', sourceUrl: 'https://mahi902.github.io/Aurora/chat.html' }, 
    { id: 'clock', name: 'Clock', icon: 'fa-solid fa-clock', color: '#1A5276', sourceUrl: 'https://mahi902.github.io/Aurora/clock.html' }, 
    { id: 'example', name: 'Code Editor', icon: 'fa-solid fa-code', color: '#2471A3', sourceUrl: 'https://mahi902.github.io/Aurora/frontendide.html' }, 
    { id: 'dcmnteditor', name: 'DocuWrite Pro', icon: 'fa-solid fa-file', color: '#1E90FF', sourceUrl: 'https://mahi902.github.io/Aurora/documenteditor.html' }, 
    { id: 'discs', name: 'Discs', icon: 'fa-solid fa-compact-disc', color: '#154360', sourceUrl: 'https://mahi902.github.io/Aurora/discs.html' }, 
    { id: 'files', name: 'Files', icon: 'fa-solid fa-folder', color: '#21618C', sourceUrl: 'https://mahi902.github.io/Aurora/files.html' },
    { id: 'photos', name: 'Image Editor', icon: 'fa-solid fa-image', color: '#2980B9', sourceUrl: 'https://mahi902.github.io/Aurora/imageeditor.html' }, 
    { id: 'notes', name: 'Notes', icon: 'fa-solid fa-clipboard', color: '#5499C7', sourceUrl: 'https://mahi902.github.io/Aurora/notes.html' }, 
    { id: 'settings', name: 'Settings', icon: 'fa-solid fa-gears', color: '#34495E' }, 
    { id: 'store', name: 'Store', icon: 'fa-solid fa-store', color: '#1E90FF', sourceUrl: 'https://mahi902.github.io/Aurora/store.html' },
    { id: 'terminal', name: 'Terminal', icon: 'fa-solid fa-terminal', color: '#3498DB', sourceUrl: 'https://mahi902.github.io/Aurora/terminal.html' },
    { id: 'wf', name: 'Dictionary', icon: 'fa-solid fa-book', color: '#5D6D7E', sourceUrl: 'https://mahi902.github.io/Aurora/wordfinder.html' }, 
    { id: 'about', name: 'About', icon: 'fa-solid fa-info', color: '#2E4053', sourceUrl: 'https://mahi902.github.io/Aurora/About.html' }, 
    { id: 'Zv2.1.12', name: 'Zv2.1.12', icon: 'fa-solid fa-question', color: '#85C1E9', sourceUrl: 'https://mahi902.github.io/Aurora/z.html' }, 
];


        const DEFAULT_APPS = {};
        USER_APPS_ARRAY.forEach(app => {
            DEFAULT_APPS[app.id] = { 
                ...app, 
                isDefault: true, 
                isPinned: app.id === 'browser' || app.id === 'settings', // Pin browser and settings by default
                timeSpent: 0 
            };
        });

        let appState = {
            wallpaper: DEFAULT_WALLPAPER,
            taskbarPosition: 'bottom',
            apps: DEFAULT_APPS,
            user: {
                name: 'Aurora User',
                pfp: DEFAULT_PFP,
                passwordHash: DEFAULT_PASSWORD_HASH 
            },
            desktopIcons: {
                'browser': { x: 50, y: 50 },
                'settings': { x: 50, y: 150 }
            }, 
            runningApps: [], 
            lastActiveAppId: null,
        };

        let activeWindowZIndex = 10;
        let targetTaskbarApp = null;
        let isDraggingDesktopIcon = false;
        let isLockScreenActive = true;
        let appStartTime = {};

        // --- DOM Elements ---
        const desktopContainer = document.getElementById('desktop-container');
        const lockScreenEl = document.getElementById('lock-screen');
        const lockBackgroundBlurEl = document.getElementById('lock-background-blur');
        const unlockForm = document.getElementById('unlock-form');
        const passwordInput = document.getElementById('password-input');
        const unlockError = document.getElementById('unlock-error');
        const lockPfp = document.getElementById('lock-pfp');
        const lockUsername = document.getElementById('lock-username');
        const notificationBox = document.getElementById('notification-box');

        const taskbarContainer = document.getElementById('taskbar-container');
        const startButton = document.getElementById('start-button');
        const startMenu = document.getElementById('start-menu');
        const allAppsList = document.getElementById('all-apps-list');
        const pinnedAppsList = document.getElementById('pinned-apps-list');
        const menuPfp = document.getElementById('menu-pfp');
        const menuUsername = document.getElementById('menu-username');
        const taskbarAppsEl = document.getElementById('taskbar-apps');
        const desktopIconsEl = document.getElementById('desktop-icons');
        const appWindowsEl = document.getElementById('app-windows');

        const contextMenu = document.getElementById('context-menu');
        const contextAddDesktop = document.getElementById('context-add-desktop');
        const contextRemoveDesktop = document.getElementById('context-remove-desktop');
        const contextPinStart = document.getElementById('context-pin-start');
        const contextUnpinStart = document.getElementById('context-unpin-start');
        const contextOpenApp = document.getElementById('context-open-app');

        const timeSidebar = document.getElementById('time-sidebar');
        const statusButton = document.getElementById('status-button');
        const sidebarTimeDateDisplay = document.getElementById('sidebar-time-date-display');
        
        // --- Utility Functions ---

        /** Toggles the taskbar position between top and bottom. */
        function toggleTaskbarPosition() {
            appState.taskbarPosition = appState.taskbarPosition === 'bottom' ? 'top' : 'bottom';
            saveState();
            renderDesktop();
            showNotification('Settings Applied', `Taskbar moved to the ${appState.taskbarPosition}.`);
        }

        /** Shows a temporary notification on the desktop. */
        function showNotification(title, message, duration = 5000) {
            document.getElementById('notification-title').textContent = title;
            document.getElementById('notification-message').textContent = message;

            // Show notification by sliding it in
            notificationBox.classList.remove('hidden', 'translate-x-full');
            notificationBox.classList.add('translate-x-0');

            setTimeout(() => {
                // Hide notification by sliding it out
                notificationBox.classList.remove('translate-x-0');
                notificationBox.classList.add('translate-x-full');
                
                // Wait for transition to finish before hiding the container
                setTimeout(() => {
                    notificationBox.classList.add('hidden');
                }, 300); 
            }, duration);
        }

        /** Shows a custom modal dialog (replaces alert/confirm) */
        function showModal(title, message, isConfirm = false) {
            return new Promise(resolve => {
                const modal = document.getElementById('custom-modal');
                document.getElementById('modal-title').textContent = title;
                document.getElementById('modal-message').textContent = message;
                const confirmBtn = document.getElementById('modal-confirm');
                const cancelBtn = document.getElementById('modal-cancel');

                if (isConfirm) {
                    confirmBtn.classList.remove('hidden');
                    cancelBtn.classList.remove('hidden');
                    confirmBtn.textContent = 'Delete'; 
                    confirmBtn.classList.remove('bg-indigo-600');
                    confirmBtn.classList.add('bg-red-600');
                } else {
                    confirmBtn.classList.remove('hidden'); 
                    confirmBtn.textContent = 'OK';
                    confirmBtn.classList.remove('bg-red-600');
                    confirmBtn.classList.add('bg-indigo-600');
                    cancelBtn.classList.add('hidden');
                }

                modal.classList.remove('hidden');
                modal.classList.add('flex');

                confirmBtn.onclick = () => {
                    modal.classList.add('hidden');
                    modal.classList.remove('flex');
                    resolve(true);
                };

                cancelBtn.onclick = () => {
                    modal.classList.add('hidden');
                    modal.classList.remove('flex');
                    resolve(false);
                };
            });
        }

        /** Saves the entire appState object to localStorage. */
        function saveState() {
            try {
                Object.values(appState.apps).forEach(app => {
                    appState.apps[app.id].timeSpent = app.timeSpent || 0;
                    appState.apps[app.id].isPinned = app.isPinned || false;
                });
                localStorage.setItem(STORAGE_KEY, JSON.stringify(appState));
            } catch (e) {
                console.error("Error saving state:", e);
            }
        }

        /** Loads state from localStorage or initializes defaults. */
        function loadState() {
            try {
                const savedState = localStorage.getItem(STORAGE_KEY);
                if (savedState) {
                    const loadedState = JSON.parse(savedState);

                    const mergedApps = { ...DEFAULT_APPS };
                    for (const [id, app] of Object.entries(loadedState.apps)) {
                        mergedApps[id] = { 
                            ...app, 
                            isDefault: DEFAULT_APPS[id] ? true : app.isDefault || false 
                        };
                    }
                    loadedState.apps = mergedApps;

                    // Ensure running apps are cleared on load, as per requirement to close them on exit.
                    loadedState.runningApps = [];
                    loadedState.lastActiveAppId = null;

                    appState = loadedState;
                } else {
                    saveState(); 
                }
            } catch (e) {
                console.error("Error loading state:", e);
            }
        }

        /** Updates the clock display in the taskbar, lock screen, and sidebar. */
        function updateClock() {
            const now = new Date();
            
            // Taskbar and Lock Screen Time
            const timeOptions = { hour: '2-digit', minute: '2-digit', hour12: true };
            const time = now.toLocaleTimeString('en-US', timeOptions);
            document.getElementById('taskbar-time').textContent = time;

            if (isLockScreenActive) {
                const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                const date = now.toLocaleDateString('en-US', dateOptions);
                document.getElementById('lock-time').textContent = time;
                document.getElementById('lock-date').textContent = date;
            }

            // Sidebar Detailed Display
            if (sidebarTimeDateDisplay) {
                const dayName = now.toLocaleDateString('en-US', { weekday: 'long' });
                const monthName = now.toLocaleDateString('en-US', { month: 'long' });
                const dayNum = now.getDate();
                const year = now.getFullYear();

                sidebarTimeDateDisplay.innerHTML = `
                    <p class="text-6xl font-extralight mb-1 text-gray-900">${time}</p>
                    <p class="text-xl font-medium text-gray-700">${dayName}, ${monthName} ${dayNum}, ${year}</p>
                `;
            }
        }

        /** Locks the screen and saves app state. Hides the taskbar. */
        function lockScreen() {
            isLockScreenActive = true;
            lockScreenEl.classList.remove('hidden');
            lockScreenEl.classList.add('flex');
            passwordInput.value = '';
            unlockError.classList.add('hidden');
            document.getElementById('lock-pfp').src = appState.user.pfp;
            document.getElementById('lock-username').textContent = appState.user.name;
            lockBackgroundBlurEl.style.backgroundImage = `url('${appState.wallpaper}')`; 

            // HIDE TASKBAR when locked
            taskbarContainer.classList.add('opacity-0', 'pointer-events-none');

            // Stop tracking time for running apps
            Object.keys(appStartTime).forEach(id => {
                const duration = Date.now() - appStartTime[id];
                if (appState.apps[id]) {
                    appState.apps[id].timeSpent = (appState.apps[id].timeSpent || 0) + duration;
                }
                delete appStartTime[id];
            });
            saveState();
        }

        /** Unlocks the screen and starts tracking time. Shows the taskbar. */
        function unlockScreen() {
            isLockScreenActive = false;
            lockScreenEl.classList.add('hidden');
            lockScreenEl.classList.remove('flex');
            
            // SHOW TASKBAR when unlocked
            taskbarContainer.classList.remove('opacity-0', 'pointer-events-none');

            // Start tracking time for currently running apps
            appState.runningApps.forEach(app => {
                appStartTime[app.id] = Date.now();
            });
        }

        /** Handles the one-time bypass for the very first launch. */
        function initialSetupBypass() {
            localStorage.setItem(FIRST_RUN_KEY, 'true');
            
            // Clear the default password hash so a custom one is required next time
            appState.user.passwordHash = ''; 
            
            unlockScreen();

            showNotification(
                'SECURITY WARNING: Action Required', 
                'The lock screen was temporarily bypassed. Please set a strong, custom password in Settings > User immediately.', 
                10000
            );
            saveState();
        }

        /** Initializes the desktop UI based on state. */
        function renderDesktop() {
            // 1. Wallpaper
            desktopContainer.style.backgroundImage = `url('${appState.wallpaper}')`;

            // 2. Taskbar Position
            taskbarContainer.classList.remove('taskbar-top', 'taskbar-bottom');
            taskbarContainer.classList.add(`taskbar-${appState.taskbarPosition}`);
            if (appState.taskbarPosition === 'top') {
                desktopIconsEl.style.paddingTop = '56px'; 
                desktopIconsEl.style.paddingBottom = '16px';
            } else { // bottom
                desktopIconsEl.style.paddingTop = '16px';
                desktopIconsEl.style.paddingBottom = '56px'; 
            }

            // 3. User Info in Menu
            menuPfp.src = appState.user.pfp;
            menuUsername.textContent = appState.user.name;

            // 4. Render Apps
            renderStartMenu();
            renderTaskbar();
            renderDesktopIcons();
            renderAppWindows(); 
        }

        /** Renders all currently running application windows. Called on initialization. */
        function renderAppWindows() {
            appWindowsEl.innerHTML = ''; 
            appState.runningApps.forEach(runningApp => {
                const app = appState.apps[runningApp.id];
                if (app) {
                    createAppWindow(app, runningApp);
                    if (runningApp.isHidden) {
                         document.getElementById(`app-window-${app.id}`).classList.add('hidden');
                    }
                }
            });
            if (appState.lastActiveAppId) {
                focusAppWindow(appState.lastActiveAppId);
            }
        }


        // --- App Management ---

        /** Generates an HTML icon element (Updated for Font Awesome) */
        function createAppIcon(appId, size = 'large') {
            const app = appState.apps[appId];
            if (!app) return '';

            const sizeClass = size === 'large' ? 'w-10 h-10 text-2xl' : 'w-8 h-8 text-xl';
            const hoverClass = size === 'large' ? 'hover:scale-105' : 'hover:bg-gray-200';
            // Use Font Awesome class directly
            const iconContent = `<i class="${app.icon}"></i>`; 

            return `
                <div class="p-2 rounded-lg flex flex-col items-center justify-center transition ${hoverClass} cursor-pointer group"
                     data-app-id="${appId}">
                    <div class="${sizeClass} rounded-lg flex items-center justify-center text-white shadow-md transition"
                         style="background-color: ${app.color};">
                        ${iconContent}
                    </div>
                    <span class="text-xs mt-1 text-center truncate w-full ${size === 'large' ? 'block' : 'hidden'}">${app.name}</span>
                </div>
            `;
        }

        /** Renders the Start Menu content (All Apps and Pinned). */
        function renderStartMenu() {
            // All Apps List (Left)
            allAppsList.innerHTML = Object.values(appState.apps).sort((a, b) => a.name.localeCompare(b.name)).map(app => `
                <button data-app-id="${app.id}" onclick="openApp('${app.id}')"
                        class="w-full text-left p-2 rounded-lg hover:bg-gray-200 flex items-center space-x-3 transition duration-150 app-menu-item">
                    <div class="w-8 h-8 rounded-md flex items-center justify-center text-white" style="background-color: ${app.color};">
                        <i class="${app.icon} text-xl"></i>
                    </div>
                    <span class="text-sm font-medium">${app.name}</span>
                </button>
            `).join('');

            // Pinned Apps Grid (Right)
            const pinnedApps = Object.values(appState.apps).filter(app => app.isPinned);
            pinnedAppsList.innerHTML = pinnedApps.map(app => `
                <div data-app-id="${app.id}" onclick="openApp('${app.id}')" class="p-2 flex flex-col items-center hover:bg-gray-200 rounded-lg transition duration-150 cursor-pointer">
                    ${createAppIcon(app.id, 'small')}
                    <span class="text-xs text-center mt-1 truncate w-full">${app.name}</span>
                </div>
            `).join('');

            document.querySelectorAll('#start-menu [data-app-id]').forEach(item => {
                item.addEventListener('contextmenu', (e) => showContextMenu(e, item.dataset.appId));
            });
        }

        /** Renders the Taskbar icons (Updated for Font Awesome). */
        function renderTaskbar() {
            taskbarAppsEl.innerHTML = appState.runningApps.map(runningApp => {
                const app = appState.apps[runningApp.id];
                if (!app) return '';
                const isActive = appState.lastActiveAppId === runningApp.id;
                const activeClass = isActive ? 'bg-indigo-600/70 border-b-2 border-indigo-900' : '';

                return `
                    <button data-app-id="${app.id}"
                            onclick="toggleAppWindow('${app.id}')"
                            oncontextmenu="showContextMenu(event, '${app.id}')"
                            class="w-10 h-10 p-1 rounded-lg ${activeClass} hover:bg-white/50 transition duration-150 flex items-center justify-center">
                        <div class="w-full h-full rounded-md flex items-center justify-center text-white" style="background-color: ${app.color};">
                            <i class="${app.icon} text-xl"></i>
                        </div>
                    </button>
                `;
            }).join('');
        }

        /** Renders the Desktop Icons with drag-and-drop (Updated for Font Awesome). */
        function renderDesktopIcons() {
            desktopIconsEl.innerHTML = Object.entries(appState.desktopIcons).map(([id, pos]) => {
                const app = appState.apps[id];
                if (!app) return '';

                return `
                    <div id="desktop-icon-${id}"
                         data-app-id="${id}"
                         class="absolute w-20 flex flex-col items-center p-2 rounded-lg hover:bg-white/30 transition duration-150 cursor-pointer text-white text-shadow-md desktop-icon-draggable"
                         style="left: ${pos.x}px; top: ${pos.y}px;"
                         ondblclick="openApp('${id}')"
                         oncontextmenu="showContextMenu(event, '${id}')">
                        ${createAppIcon(id, 'large')}
                        <span class="text-xs text-center mt-1 font-medium bg-black/50 px-1 rounded">${app.name}</span>
                    </div>
                `;
            }).join('');

            setupDesktopIconDrag();
        }
        
        /** Defines the content for each application (Updated to use iframe/sourceUrl). */
        function getAppContent(appId) {
            const app = appState.apps[appId];
            if (!app) return '';

            // Settings remains internal for core OS function
            if (appId === 'settings') {
                return getSettingsAppHTML(); 
            } 
            
            // All other apps use their sourceUrl in an iframe
            if (app.sourceUrl) {
                return `<iframe src="${app.sourceUrl}" class="w-full h-full border-0 rounded-lg"></iframe>`;
            } 
            
            // Fallback
            return `<div class="text-center p-10"><h2 class="text-xl font-bold mb-3">App Not Available</h2><p>The source URL for the '${app.name}' app is missing.</p></div>`;
        }

        // --- Rest of the App Logic (Unchanged or adapted) ---

        /** Handles opening a new app or bringing an existing one to the front. */
        function openApp(appId) {
            startMenu.classList.remove('open', 'scale-100', 'opacity-100', 'pointer-events-auto');
            startMenu.classList.add('scale-95', 'opacity-0', 'pointer-events-none');

            let runningApp = appState.runningApps.find(a => a.id === appId);
            let appWindowEl = document.getElementById(`app-window-${appId}`);

            // Stop time for the previously active app
            if (appState.lastActiveAppId && appState.lastActiveAppId !== appId) {
                const duration = Date.now() - (appStartTime[appState.lastActiveAppId] || Date.now());
                if (appState.apps[appState.lastActiveAppId]) {
                    appState.apps[appState.lastActiveAppId].timeSpent = (appState.apps[appState.lastActiveAppId].timeSpent || 0) + duration;
                }
                delete appStartTime[appState.lastActiveAppId];
            }

            // Start time for the current app
            appStartTime[appId] = Date.now();
            activeWindowZIndex++;

            if (runningApp) {
                appWindowEl.style.zIndex = activeWindowZIndex;
                appWindowEl.classList.remove('hidden');
                runningApp.zIndex = activeWindowZIndex;
                runningApp.isHidden = false;
            } else {
                const app = appState.apps[appId];
                runningApp = {
                    id: appId,
                    zIndex: activeWindowZIndex,
                    x: Math.random() * 50 + 100,
                    y: Math.random() * 50 + 50,
                    width: appId === 'settings' ? 750 : 600,
                    height: appId === 'settings' ? 600 : 400,
                    isHidden: false,
                };
                appState.runningApps.push(runningApp);
                createAppWindow(app, runningApp);
            }

            renderTaskbar();
            focusAppWindow(appId);
            saveState();
        }

        /** Minimizes or restores an app window. */
        function toggleAppWindow(appId) {
            const appWindowEl = document.getElementById(`app-window-${appId}`);
            if (!appWindowEl) return;
            const runningApp = appState.runningApps.find(a => a.id === appId);

            if (appWindowEl.classList.contains('hidden') || appState.lastActiveAppId !== appId) {
                openApp(appId);
            } else {
                appWindowEl.classList.add('hidden');
                if (runningApp) runningApp.isHidden = true;

                const highestZIndexApp = appState.runningApps
                    .filter(a => a.id !== appId && !a.isHidden)
                    .sort((a, b) => b.zIndex - a.zIndex)[0];

                appState.lastActiveAppId = highestZIndexApp ? highestZIndexApp.id : null;
                renderTaskbar();
                focusAppWindow(appState.lastActiveAppId);
            }
        }

        /** Closes an app window. */
        function closeApp(appId) {
            const appWindowEl = document.getElementById(`app-window-${appId}`);
            if (appWindowEl) {
                appWindowEl.remove();
            }

            appState.runningApps = appState.runningApps.filter(app => app.id !== appId);
            const duration = Date.now() - (appStartTime[appId] || Date.now());
            if (appState.apps[appId]) {
                appState.apps[appId].timeSpent = (appState.apps[appId].timeSpent || 0) + duration;
            }
            delete appStartTime[appId];

            if (appState.lastActiveAppId === appId) {
                 const highestZIndexApp = appState.runningApps
                    .filter(a => !a.isHidden)
                    .sort((a, b) => b.zIndex - a.zIndex)[0];

                appState.lastActiveAppId = highestZIndexApp ? highestZIndexApp.id : null;
            }

            renderTaskbar();
            saveState();
        }

        /** Brings a window to the front. */
        function focusAppWindow(appId) {
            appState.runningApps.forEach(app => {
                const windowEl = document.getElementById(`app-window-${app.id}`);
                if (windowEl) {
                    if (app.id === appId) {
                        activeWindowZIndex++;
                        windowEl.style.zIndex = activeWindowZIndex;
                        app.zIndex = activeWindowZIndex;
                        windowEl.querySelector('.window-titlebar').classList.remove('bg-gray-300');
                        windowEl.querySelector('.window-titlebar').classList.add('bg-indigo-600/90', 'text-white');
                        appState.lastActiveAppId = appId;
                    } else {
                        windowEl.querySelector('.window-titlebar').classList.remove('bg-indigo-600/90', 'text-white');
                        windowEl.querySelector('.window-titlebar').classList.add('bg-gray-300');
                    }
                }
            });
            renderTaskbar();
        }

        /** Creates the HTML for a draggable application window. */
        function createAppWindow(app, runningApp) {
            const appWindowEl = document.createElement('div');
            appWindowEl.id = `app-window-${app.id}`;
            
            runningApp.width = Math.max(runningApp.width, 300);
            runningApp.height = Math.max(runningApp.height, 200);

            appWindowEl.className = `absolute rounded-xl shadow-2xl overflow-hidden glass-menu transition-shadow duration-200 resize w-[${runningApp.width}px] h-[${runningApp.height}px]`;
            appWindowEl.style.left = `${runningApp.x}px`;
            appWindowEl.style.top = `${runningApp.y}px`;
            appWindowEl.style.width = `${runningApp.width}px`;
            appWindowEl.style.height = `${runningApp.height}px`;
            appWindowEl.style.zIndex = runningApp.zIndex;
            appWindowEl.setAttribute('data-app-id', app.id);
            appWindowEl.onclick = () => focusAppWindow(app.id);
            appWindowEl.addEventListener('contextmenu', (e) => {
                e.stopPropagation(); 
            });


            const content = getAppContent(app.id);

            appWindowEl.innerHTML = `
                <!-- Title Bar (Drag Handle) -->
                <div class="window-titlebar bg-indigo-600/90 text-white p-2 flex justify-between items-center cursor-move" onmousedown="startDrag(event, '${app.id}')">
                    <div class="flex items-center space-x-2">
                        <div class="w-6 h-6 rounded flex items-center justify-center text-white text-base" style="background-color: ${app.color};">
                            <i class="${app.icon} text-sm"></i>
                        </div>
                        <span class="font-semibold text-sm">${app.name}</span>
                    </div>
                    <div class="flex items-center space-x-1">
                        <button onclick="toggleAppWindow('${app.id}')" class="w-6 h-6 rounded-full hover:bg-white/30 transition duration-150 flex items-center justify-center">
                            <span class="material-symbols-outlined fill-0 text-lg">remove</span>
                        </button>
                        <button onclick="toggleFullscreenApp('${app.id}')" class="w-6 h-6 rounded-full hover:bg-white/30 transition duration-150 flex items-center justify-center">
                            <span class="material-symbols-outlined fill-0 text-lg fullscreen-btn-icon">fullscreen</span>
                        </button>
                        <button onclick="closeApp('${app.id}')" class="w-6 h-6 rounded-full hover:bg-red-500 transition duration-150 flex items-center justify-center">
                            <span class="material-symbols-outlined fill-0 text-lg">close</span>
                        </button>
                    </div>
                </div>
                <!-- Body -->
                <div class="window-body p-0 overflow-hidden" style="height: calc(100% - 36px);">
                    ${content}
                </div>
            `;
            appWindowsEl.appendChild(appWindowEl);
            
            const resizeObserver = new ResizeObserver(entries => {
                for (let entry of entries) {
                    const runningApp = appState.runningApps.find(a => a.id === app.id);
                    if (runningApp) {
                        runningApp.width = entry.contentRect.width;
                        runningApp.height = entry.contentRect.height;
                        saveState();
                    }
                }
            });
            resizeObserver.observe(appWindowEl);


            if (app.id === 'settings') {
                setupSettingsApp();
            }

            if (!runningApp.isHidden) {
                focusAppWindow(app.id); 
            }
        }
        
        /** Toggles an app window between fullscreen and its previous state. */
        function toggleFullscreenApp(appId) {
            const appWindowEl = document.getElementById(`app-window-${appId}`);
            if (!appWindowEl) return;

            const isMaximized = appWindowEl.dataset.isMaximized === 'true';
            const fullscreenIcon = appWindowEl.querySelector('.fullscreen-btn-icon');

            if (isMaximized) {
                // Restore from fullscreen
                appWindowEl.style.left = appWindowEl.dataset.prevX;
                appWindowEl.style.top = appWindowEl.dataset.prevY;
                appWindowEl.style.width = appWindowEl.dataset.prevW;
                appWindowEl.style.height = appWindowEl.dataset.prevH;
                appWindowEl.dataset.isMaximized = 'false';
                appWindowEl.classList.remove('fullscreen-window');
                appWindowEl.style.resize = 'both';
                if (fullscreenIcon) fullscreenIcon.textContent = 'fullscreen';
            } else {
                // Go to fullscreen
                appWindowEl.dataset.prevX = appWindowEl.style.left;
                appWindowEl.dataset.prevY = appWindowEl.style.top;
                appWindowEl.dataset.prevW = appWindowEl.style.width;
                appWindowEl.dataset.prevH = appWindowEl.style.height;

                const taskbarHeight = taskbarContainer.offsetHeight;
                let top = '0px';
                let height = `calc(100vh - ${taskbarHeight}px)`;

                if (appState.taskbarPosition === 'top') {
                    top = `${taskbarHeight}px`;
                }
                
                appWindowEl.style.top = top;
                appWindowEl.style.left = '0px';
                appWindowEl.style.width = '100vw';
                appWindowEl.style.height = height;
                appWindowEl.dataset.isMaximized = 'true';
                appWindowEl.classList.add('fullscreen-window');
                appWindowEl.style.resize = 'none';
                if (fullscreenIcon) fullscreenIcon.textContent = 'fullscreen_exit';
            }
            focusAppWindow(appId);
        }

        // --- Drag/Drop Window Logic ---
        let dragTarget = null;
        let offset = { x: 0, y: 0 };

        function startDrag(e, appId) {
            e.preventDefault();
            dragTarget = document.getElementById(`app-window-${appId}`);
            if (dragTarget.dataset.isMaximized === 'true') return;
            focusAppWindow(appId); 

            const rect = dragTarget.getBoundingClientRect();
            offset.x = e.clientX - rect.left;
            offset.y = e.clientY - rect.top;

            document.addEventListener('mousemove', dragMove);
            document.addEventListener('mouseup', dragEnd);
        }

        function dragMove(e) {
            if (!dragTarget) return;
            const newX = e.clientX - offset.x;
            const newY = e.clientY - offset.y;

            dragTarget.style.left = `${newX}px`;
            dragTarget.style.top = `${newY}px`;
        }

        function dragEnd(e) {
            if (dragTarget) {
                const appId = dragTarget.dataset.appId;
                const runningApp = appState.runningApps.find(a => a.id === appId);
                if (runningApp) {
                    runningApp.x = parseFloat(dragTarget.style.left);
                    runningApp.y = parseFloat(dragTarget.style.top);
                    saveState();
                }
            }
            dragTarget = null;
            document.removeEventListener('mousemove', dragMove);
            document.removeEventListener('mouseup', dragEnd);
        }

        // --- Context Menu Logic ---
        let contextTargetAppId = null;

        function showContextMenu(e, appId) {
            e.preventDefault();
            e.stopPropagation(); 
            hideContextMenu();

            contextTargetAppId = appId;
            const app = appState.apps[appId];

            let menuX = e.clientX;
            let menuY = e.clientY;

            if (menuX + 200 > window.innerWidth) menuX = window.innerWidth - 210;
            if (menuY + 200 > window.innerHeight) menuY = window.innerHeight - 210;


            contextMenu.style.left = `${menuX}px`;
            contextMenu.style.top = `${menuY}px`;
            contextMenu.classList.remove('hidden');

            const isDesktopIcon = appState.desktopIcons.hasOwnProperty(appId);
            contextAddDesktop.classList.toggle('hidden', isDesktopIcon);
            contextRemoveDesktop.classList.toggle('hidden', !isDesktopIcon);

            contextPinStart.classList.toggle('hidden', app.isPinned);
            contextUnpinStart.classList.toggle('hidden', !app.isPinned);
        }

        function hideContextMenu() {
            contextMenu.classList.add('hidden');
            contextTargetAppId = null;
        }

        // Context Menu Action Handlers
        contextOpenApp.onclick = () => {
            if (contextTargetAppId) openApp(contextTargetAppId);
            hideContextMenu();
        };

        contextAddDesktop.onclick = () => {
            if (contextTargetAppId) {
                const iconWidth = 80; 
                const iconHeight = 80;
                let x = 50, y = 50;
                let foundSpot = false;
                let maxAttempts = 100;

                for (let i = 0; i < maxAttempts; i++) {
                    let overlaps = false;
                    for (const pos of Object.values(appState.desktopIcons)) {
                        if (x < pos.x + iconWidth && x + iconWidth > pos.x &&
                            y < pos.y + iconHeight && y + iconHeight > pos.y) {
                            overlaps = true;
                            break;
                        }
                    }

                    if (!overlaps) {
                        foundSpot = true;
                        break;
                    }

                    x += iconWidth + 10;
                    if (x > window.innerWidth - iconWidth - 100) {
                        x = 50;
                        y += iconHeight + 10;
                    }
                }

                appState.desktopIcons[contextTargetAppId] = { x: x, y: y };
                renderDesktopIcons();
                saveState();
            }
            hideContextMenu();
        };

        contextRemoveDesktop.onclick = () => {
            if (contextTargetAppId) {
                delete appState.desktopIcons[contextTargetAppId];
                renderDesktopIcons();
                saveState();
            }
            hideContextMenu();
        };

        contextPinStart.onclick = () => {
            if (contextTargetAppId) {
                appState.apps[contextTargetAppId].isPinned = true;
                renderStartMenu();
                saveState();
            }
            hideContextMenu();
        };

        contextUnpinStart.onclick = () => {
            if (contextTargetAppId) {
                appState.apps[contextTargetAppId].isPinned = false;
                renderStartMenu();
                saveState();
            }
            hideContextMenu();
        };


        // --- Desktop Icon Drag/Drop Logic (Same as before) ---
        let dragIconTarget = null;

        function setupDesktopIconDrag() {
            document.querySelectorAll('.desktop-icon-draggable').forEach(iconEl => {
                iconEl.onmousedown = (e) => {
                    if (e.button !== 0) return;
                    e.preventDefault();
                    e.stopPropagation(); 
                    isDraggingDesktopIcon = true;
                    dragIconTarget = iconEl;

                    const rect = dragIconTarget.getBoundingClientRect();
                    offset.x = e.clientX - rect.left;
                    offset.y = e.clientY - rect.top;

                    dragIconTarget.style.transition = 'none';

                    document.addEventListener('mousemove', dragIconMove);
                    document.addEventListener('mouseup', dragIconEnd);
                };
            });
        }

        function dragIconMove(e) {
            if (!dragIconTarget) return;
            const newX = e.clientX - offset.x;
            const newY = e.clientY - offset.y;

            dragIconTarget.style.left = `${newX}px`;
            dragIconTarget.style.top = `${newY}px`;
        }

        function dragIconEnd(e) {
            if (dragIconTarget) {
                const appId = dragIconTarget.dataset.appId;
                const finalX = parseFloat(dragIconTarget.style.left);
                const finalY = parseFloat(dragIconTarget.style.top);

                appState.desktopIcons[appId] = { x: finalX, y: finalY };
                saveState();

                dragIconTarget.style.transition = '';
            }
            dragIconTarget = null;
            isDraggingDesktopIcon = false;
            document.removeEventListener('mousemove', dragIconMove);
            document.removeEventListener('mouseup', dragIconEnd);
        }

        // --- Settings App Specific Functions ---

        /** Generates the HTML structure for the tabbed Settings App. */
        function getSettingsAppHTML() {
            return `
                <div class="h-full flex p-4">
                    <!-- Left Sidebar (Tabs) -->
                    <div class="w-48 bg-gray-100 p-4 rounded-l-xl border-r border-gray-200">
                        <h3 class="text-xl font-bold mb-4 text-indigo-700">Settings</h3>
                        <div class="space-y-2">
                            <button class="settings-tab-btn w-full text-left p-3 rounded-lg flex items-center space-x-2 transition duration-150" data-tab="user">
                                <span class="material-symbols-outlined text-lg">person</span>
                                <span>User</span>
                            </button>
                            <button class="settings-tab-btn w-full text-left p-3 rounded-lg flex items-center space-x-2 transition duration-150" data-tab="customization">
                                <span class="material-symbols-outlined text-lg">palette</span>
                                <span>Customization</span>
                            </button>
                            <button class="settings-tab-btn w-full text-left p-3 rounded-lg flex items-center space-x-2 transition duration-150" data-tab="program">
                                <span class="material-symbols-outlined text-lg">apps</span>
                                <span>Programs</span>
                            </button>
                        </div>
                    </div>
                    <!-- Right Content Area -->
                    <div id="settings-content" class="flex-1 p-6 overflow-y-auto rounded-r-xl bg-white">
                        <!-- Content will be injected here -->
                    </div>
                </div>
            `;
        }

        /** Sets up the event listeners and initial content for the Settings App. */
        function setupSettingsApp() {
            const contentEl = document.getElementById('settings-content');
            const tabButtons = document.querySelectorAll('.settings-tab-btn');

            let currentTab = 'user';

            const changeTab = (tabName) => {
                currentTab = tabName;
                tabButtons.forEach(btn => {
                    if (btn.dataset.tab === tabName) {
                        btn.classList.add('bg-indigo-200', 'text-indigo-800');
                        btn.classList.remove('hover:bg-gray-200', 'text-gray-700');
                    } else {
                        btn.classList.remove('bg-indigo-200', 'text-indigo-800');
                        btn.classList.add('hover:bg-gray-200', 'text-gray-700');
                    }
                });
                renderTabContent(tabName);
            };

            tabButtons.forEach(btn => {
                btn.onclick = () => changeTab(btn.dataset.tab);
            });

            changeTab(currentTab);
        }

        /** Renders the content for the currently active tab. */
        function renderTabContent(tabName) {
            const contentEl = document.getElementById('settings-content');
            if (!contentEl) return;

            switch (tabName) {
                case 'user':
                    contentEl.innerHTML = renderUserTab();
                    setupUserTabListeners();
                    break;
                case 'customization':
                    contentEl.innerHTML = renderCustomizationTab();
                    setupCustomizationTabListeners();
                    break;
                case 'program':
                    contentEl.innerHTML = renderProgramTab();
                    setupProgramTabListeners();
                    break;
            }
        }

        // --- Settings Tab: User ---
        function renderUserTab() {
            return `
                <h2 class="text-3xl font-bold mb-6">User Settings</h2>
                <div class="space-y-6 max-w-lg">
                    <!-- Profile Picture -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Profile Picture (URL)</label>
                        <img id="user-pfp-preview" src="${appState.user.pfp}" onerror="this.src='${DEFAULT_PFP}'" class="w-24 h-24 rounded-full mb-3 border-4 border-indigo-300 object-cover" alt="Profile">
                        <input type="url" id="user-pfp-input" value="${appState.user.pfp}" class="w-full p-3 rounded-lg border border-gray-300 focus:ring-indigo-500 focus:border-indigo-500">
                    </div>

                    <!-- Name Change -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Display Name</label>
                        <input type="text" id="user-name-input" value="${appState.user.name}" class="w-full p-3 rounded-lg border border-gray-300 focus:ring-indigo-500 focus:border-indigo-500">
                    </div>

                    <!-- Password Change -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Change Device Password</label>
                        <input type="text" id="user-password-input" placeholder="New Password" class="w-full p-3 rounded-lg border border-gray-300 focus:ring-indigo-500 focus:border-indigo-500">
                        <p class="text-xs text-gray-500 mt-1">Changing the password will update the lock screen and local storage authentication.</p>
                        ${appState.user.passwordHash === '' ? 
                            '<p class="text-sm font-semibold text-red-500 mt-2">Security Note: Your password is currently empty. Please set a new one!</p>' : ''}
                    </div>

                    <button id="save-user-settings" class="px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-200">Save User Settings</button>
                    <p id="user-save-message" class="text-sm mt-3 text-green-600 hidden">Settings saved!</p>
                </div>
            `;
        }

        function setupUserTabListeners() {
            const pfpInput = document.getElementById('user-pfp-input');
            const nameInput = document.getElementById('user-name-input');
            const passwordInput = document.getElementById('user-password-input');
            const saveBtn = document.getElementById('save-user-settings');
            const pfpPreview = document.getElementById('user-pfp-preview');
            const saveMsg = document.getElementById('user-save-message');

            pfpInput.oninput = () => pfpPreview.src = pfpInput.value || DEFAULT_PFP;

            saveBtn.onclick = () => {
                appState.user.name = nameInput.value;
                appState.user.pfp = pfpInput.value || DEFAULT_PFP;

                if (passwordInput.value) {
                    appState.user.passwordHash = passwordInput.value; 
                    passwordInput.value = ''; 
                }

                saveState();
                renderDesktop(); 

                saveMsg.classList.remove('hidden');
                setTimeout(() => saveMsg.classList.add('hidden'), 3000);
                
                renderTabContent('user');
            };
        }

        // --- Settings Tab: Customization ---
        function renderCustomizationTab() {
            return `
                <h2 class="text-3xl font-bold mb-6">Customization</h2>
                <div class="space-y-6 max-w-lg">
                    <!-- Wallpaper Change -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Desktop Wallpaper (URL)</label>
                        <div class="w-full h-32 rounded-lg mb-3 border-4 border-gray-300 bg-cover bg-center" style="background-image: url('${appState.wallpaper}')" id="wallpaper-preview"></div>
                        <input type="url" id="wallpaper-input" value="${appState.wallpaper}" class="w-full p-3 rounded-lg border border-gray-300 focus:ring-indigo-500 focus:border-indigo-500">
                    </div>

                    <!-- Taskbar Position -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Taskbar Position</label>
                        <div class="flex space-x-4">
                            <label class="inline-flex items-center">
                                <input type="radio" name="taskbar-pos" value="bottom" ${appState.taskbarPosition === 'bottom' ? 'checked' : ''} class="form-radio text-indigo-600">
                                <span class="ml-2">Bottom</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="taskbar-pos" value="top" ${appState.taskbarPosition === 'top' ? 'checked' : ''} class="form-radio text-indigo-600">
                                <span class="ml-2">Top</span>
                            </label>
                        </div>
                    </div>

                    <button id="save-customization-settings" class="px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-200">Apply Customizations</button>
                    <p id="customization-save-message" class="text-sm mt-3 text-green-600 hidden">Customizations applied!</p>
                </div>
            `;
        }

        function setupCustomizationTabListeners() {
            const wallpaperInput = document.getElementById('wallpaper-input');
            const wallpaperPreview = document.getElementById('wallpaper-preview');
            const saveBtn = document.getElementById('save-customization-settings');
            const saveMsg = document.getElementById('customization-save-message');

            wallpaperInput.oninput = () => wallpaperPreview.style.backgroundImage = `url('${wallpaperInput.value || DEFAULT_WALLPAPER}')`;

            saveBtn.onclick = () => {
                appState.wallpaper = wallpaperInput.value || DEFAULT_WALLPAPER;
                appState.taskbarPosition = document.querySelector('input[name="taskbar-pos"]:checked').value;

                saveState();
                renderDesktop(); 

                lockBackgroundBlurEl.style.backgroundImage = `url('${appState.wallpaper}')`;

                saveMsg.classList.remove('hidden');
                setTimeout(() => saveMsg.classList.add('hidden'), 3000);
            };
        }

        // --- Settings Tab: Program ---
        function renderProgramTab() {
            const appsListHTML = Object.values(appState.apps).sort((a, b) => a.name.localeCompare(b.name)).map(app => {
                const timeInHours = (app.timeSpent / (1000 * 60 * 60)).toFixed(2);
                // Font Awesome icons
                const iconContent = `<i class="${app.icon} text-xl"></i>`; 
                return `
                    <li class="flex justify-between items-center p-3 border-b border-gray-100 hover:bg-gray-50 rounded-lg">
                        <div class="flex items-center space-x-3">
                            <div class="w-8 h-8 rounded-md flex items-center justify-center text-white text-lg" style="background-color: ${app.color};">
                                ${iconContent}
                            </div>
                            <span class="font-medium">${app.name}</span>
                        </div>
                        <div class="flex items-center space-x-4">
                            <span class="text-sm text-gray-500">${timeInHours} hours used</span>
                            ${!app.isDefault ? `<button data-app-id="${app.id}" class="delete-app-btn text-red-500 hover:text-red-700 text-sm font-medium">Delete</button>` : ''}
                        </div>
                    </li>
                `;
            }).join('');

            return `
                <h2 class="text-3xl font-bold mb-6">Program Management</h2>

                <!-- Installed Apps List -->
                <h3 class="text-xl font-semibold mb-3">Installed Applications (${Object.keys(appState.apps).length})</h3>
                <ul id="installed-apps-list" class="bg-white rounded-xl shadow-lg p-3 mb-8">
                    ${appsListHTML}
                </ul>

                <!-- Install New App Form -->
                <h3 class="text-xl font-semibold mb-3">Install New Application</h3>
                <form id="install-app-form" class="bg-white p-6 rounded-xl shadow-lg space-y-4 max-w-lg">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">App Name</label>
                        <input type="text" id="new-app-name" required class="w-full p-3 rounded-lg border border-gray-300 focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">App Source URL (e.g., website for iframe)</label>
                        <input type="url" id="new-app-url" required class="w-full p-3 rounded-lg border border-gray-300 focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Font Awesome Icon Class (e.g., 'fa-solid fa-cloud')</label>
                        <input type="text" id="new-app-icon" required class="w-full p-3 rounded-lg border border-gray-300 focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Icon Background Color (Hex Code)</label>
                        <input type="color" id="new-app-color" value="#4f46e5" class="w-full p-1 h-10 rounded-lg border border-gray-300">
                    </div>

                    <button type="submit" class="px-6 py-3 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition duration-200 w-full">Install App</button>
                    <p id="install-message" class="text-sm mt-3 text-green-600 hidden text-center"></p>
                </form>
            `;
        }

        function setupProgramTabListeners() {
            // App Installation Handler
            const installForm = document.getElementById('install-app-form');
            installForm.onsubmit = (e) => {
                e.preventDefault();
                const name = document.getElementById('new-app-name').value;
                const url = document.getElementById('new-app-url').value;
                const icon = document.getElementById('new-app-icon').value;
                const color = document.getElementById('new-app-color').value;
                const appId = name.toLowerCase().replace(/\s/g, '-').replace(/[^a-z0-9-]/g, '');

                if (appState.apps[appId]) {
                    document.getElementById('install-message').textContent = `App ID '${appId}' already exists.`;
                    document.getElementById('install-message').classList.remove('hidden', 'text-green-600');
                    document.getElementById('install-message').classList.add('text-red-600');
                    return;
                }

                appState.apps[appId] = {
                    id: appId,
                    name: name,
                    icon: icon,
                    color: color,
                    sourceUrl: url,
                    isDefault: false,
                    isPinned: false,
                    timeSpent: 0
                };

                saveState();
                renderDesktop(); 
                renderTabContent('program'); 

                const installMsg = document.getElementById('install-message');
                installMsg.textContent = `${name} installed successfully!`;
                installMsg.classList.remove('hidden', 'text-red-600');
                installMsg.classList.add('text-green-600');
                installForm.reset();
                setTimeout(() => installMsg.classList.add('hidden'), 3000);
            };

            // App Deletion Handler
            document.querySelectorAll('.delete-app-btn').forEach(btn => {
                btn.onclick = async (e) => {
                    const appIdToDelete = e.target.dataset.appId;
                    const appName = appState.apps[appIdToDelete].name;

                    const confirmed = await showModal('Delete Application', `Are you sure you want to delete the downloaded app "${appName}"? This action cannot be undone.`, true);

                    if (confirmed) {
                        delete appState.apps[appIdToDelete];
                        if (appState.desktopIcons.hasOwnProperty(appIdToDelete)) {
                            delete appState.desktopIcons[appIdToDelete];
                        }
                        closeApp(appIdToDelete); 
                        saveState();
                        renderDesktop();
                        renderTabContent('program'); 
                    }
                };
            });
        }


        // --- Event Listeners and Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            
            loadState();
            renderDesktop();
            updateClock();
            setInterval(updateClock, 1000);

            // 2. Lock screen logic
            unlockForm.onsubmit = (e) => {
                e.preventDefault();
                const enteredPassword = passwordInput.value;
                const currentHash = appState.user.passwordHash;
                
                let isAuthenticated = false;

                // Check 1: Input matches stored hash (custom password or '1234')
                if (enteredPassword === currentHash && currentHash !== '') {
                    isAuthenticated = true;
                } 
                // Check 2: One-Time Default Password Login
                else if (enteredPassword === DEFAULT_PASSWORD_HASH && currentHash === DEFAULT_PASSWORD_HASH) {
                    isAuthenticated = true;
                }
                // Check 3: Empty password allowed if user hash is empty (post-bypass)
                else if (enteredPassword === '' && currentHash === '') {
                    isAuthenticated = true;
                }


                if (isAuthenticated) {
                    
                    if (currentHash === DEFAULT_PASSWORD_HASH) {
                        appState.user.passwordHash = ''; 
                        
                        showNotification(
                            'ACTION REQUIRED: New Password Needed', 
                            'The default password has been cleared for security. Please set a strong, custom password in Settings > User immediately.', 
                            10000
                        );
                        saveState(); 
                    }

                    unlockScreen();
                } else {
                    unlockError.textContent = 'Incorrect password.';
                    unlockError.classList.remove('hidden');
                }
            };

            // 3. First Run Bypass Check
            const isFirstRun = !localStorage.getItem(FIRST_RUN_KEY);
            
            if (isFirstRun) {
                initialSetupBypass();
            } else {
                lockScreen();
            }


            // 4. Start Button / Menu Toggles
            startButton.onclick = () => {
                if (startMenu.classList.contains('open')) {
                    startMenu.classList.remove('open', 'scale-100', 'opacity-100', 'pointer-events-auto');
                    startMenu.classList.add('scale-95', 'opacity-0', 'pointer-events-none');
                } else {
                    startMenu.classList.add('open', 'scale-100', 'opacity-100', 'pointer-events-auto');
                    startMenu.classList.remove('scale-95', 'opacity-0', 'pointer-events-none');
                    renderStartMenu(); 
                }
                // Close sidebar when opening start menu
                timeSidebar.classList.remove('open');
                timeSidebar.classList.add('translate-x-full');
            };

            statusButton.onclick = () => {
                // Toggle Right Sidebar
                if (timeSidebar.classList.contains('open')) {
                    timeSidebar.classList.remove('open');
                    timeSidebar.classList.add('translate-x-full');
                } else {
                    timeSidebar.classList.add('open');
                    timeSidebar.classList.remove('translate-x-full');
                }
                // Close start menu when opening sidebar
                startMenu.classList.remove('open', 'scale-100', 'opacity-100', 'pointer-events-auto');
                startMenu.classList.add('scale-95', 'opacity-0', 'pointer-events-none');
            };

            // 5. Global Click Listener (Close Menus)
            document.addEventListener('click', (e) => {
                if (startMenu.classList.contains('open') && !startMenu.contains(e.target) && !startButton.contains(e.target)) {
                    startMenu.classList.remove('open', 'scale-100', 'opacity-100', 'pointer-events-auto');
                    startMenu.classList.add('scale-95', 'opacity-0', 'pointer-events-none');
                }
                if (timeSidebar.classList.contains('open') && !timeSidebar.contains(e.target) && !statusButton.contains(e.target)) {
                    timeSidebar.classList.remove('open');
                    timeSidebar.classList.add('translate-x-full');
                }
                if (!contextMenu.contains(e.target)) hideContextMenu();

                if (isDraggingDesktopIcon) e.preventDefault();
            });

            // 6. Global Context Menu Suppression
            desktopContainer.addEventListener('contextmenu', (e) => e.preventDefault());
            
        });

        // --- Session Closure Logic (New Requirement) ---
        /** Clears running apps and saves state when the user navigates away or closes the tab. */
        window.addEventListener('beforeunload', () => {
            // 1. Save time spent for any still-running apps
            Object.keys(appStartTime).forEach(id => {
                const duration = Date.now() - appStartTime[id];
                if (appState.apps[id]) {
                    appState.apps[id].timeSpent = (appState.apps[id].timeSpent || 0) + duration;
                }
            });

            // 2. Clear running apps to simulate closure for next session load
            appState.runningApps = [];
            appState.lastActiveAppId = null;
            
            // 3. Persist the state
            saveState();
        });

    </script>
</body>
</html>



<body onclick="if(event.clientX<50&&event.clientY<50)document.fullscreenElement?document.exitFullscreen():document.documentElement.requestFullscreen()">
    
