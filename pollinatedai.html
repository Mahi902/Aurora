<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pollinated by Aurora</title>
    <!-- Load Tailwind CSS from CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Google Material Symbols from CDN -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Symbols+Outlined" rel="stylesheet">
    <style>
        /* Define Inter font for a clean look using standard link */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        :root {
            --primary-color: #1e40af; /* Blue-700 */
            --primary-hover: #1d4ed8; /* Blue-600 */
            --bg-color: #f8f8f8;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
        }

        /* Custom scrollbar for chat history */
        #chat-history {
            scrollbar-width: thin;
            scrollbar-color: #9ca3af #f3f4f6;
        }
        #chat-history::-webkit-scrollbar {
            width: 8px;
        }
        #chat-history::-webkit-scrollbar-track {
            background: #f3f4f6;
        }
        #chat-history::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 20px;
            border: 3px solid #f3f4f6;
        }
        /* Style for the loading spinner */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border-left-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Input specific styles to fix alignment and match the image aesthetics */
        #input-wrapper {
            box-shadow: 0 1px 6px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            transition: box-shadow 0.3s;
            align-items: center; /* Fixes vertical alignment */
        }
        #input-wrapper:focus-within {
             box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        #user-input {
            /* Adjust padding to be vertically centered within the wrapper */
            padding-top: 8px; 
            padding-bottom: 8px;
            line-height: 1.5; /* Ensure comfortable line spacing */
        }

        /* Info Box style for the Pollinated title click */
        .slide-out-box {
            position: fixed;
            top: 0;
            right: 0;
            width: 100%;
            max-width: 350px;
            height: 100%;
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out, box-shadow 0.3s;
            z-index: 50; 
            border-left: 1px solid #e5e7eb; 
            background-color: white;
        }
        .slide-out-box.open {
            transform: translateX(0);
            box-shadow: -4px 0 10px rgba(0, 0, 0, 0.1);
        }
        
        /* Typing cursor animation */
        .typing-cursor {
            display: inline-block;
            width: 2px;
            height: 1em;
            background-color: currentColor;
            margin-left: 2px;
            animation: blink 1s infinite;
            vertical-align: middle;
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }
    </style>
</head>
<body class="w-screen min-h-screen flex flex-col overflow-x-hidden">

    <!-- Main Content Area -->
    <div class="flex-grow flex flex-col h-full bg-white relative">
        
        <!-- Header -->
        <header class="p-4 border-b border-gray-100 flex justify-start items-center flex-shrink-0">
            <!-- Pollinated Title - Now opens the Info Box -->
            <h1 onclick="openInfoBox()" class="text-xl font-semibold text-gray-800 flex items-center cursor-pointer hover:text-blue-700 transition duration-150">
                Pollinated
                <span class="material-symbols-outlined ml-1 text-base">expand_more</span>
            </h1>
        </header>

        <!-- Chat Main Area -->
        <main id="chat-main-content" class="flex-grow overflow-y-auto p-4 flex flex-col justify-center items-center">
            
            <!-- Welcome Screen (Initial State) -->
            <div id="welcome-message" class="text-center transition-opacity duration-300 p-8 max-w-lg">
                <!-- Friendly default message -->
                <h1 id="main-welcome-title" class="text-4xl md:text-5xl font-extrabold text-gray-900 mb-6">Hello! How can I help you today?</h1>
                <div id="welcome-loader" class="spinner mx-auto hidden"></div>
            </div>

            <!-- Chat History Area -->
            <!-- Initially hidden. Shown only after the first user message. -->
            <div id="chat-history" class="hidden flex-grow w-full px-4 pt-16 space-y-6 overflow-y-auto">
                
            </div>
        </main>
        
        <!-- Input Area (Fixed to Bottom, Centered) -->
        <div class="w-full flex justify-center py-4 bg-white flex-shrink-0">
            <div id="input-container" class="w-full max-w-3xl px-4">
                <div id="loading-indicator" class="hidden text-center py-2">
                    <div class="spinner mx-auto"></div>
                    <p class="text-sm text-gray-500 mt-1">AI is thinking...</p>
                </div>

                <!-- Text Input and Send Button -->
                <div id="input-wrapper" class="flex space-x-2 bg-white border border-gray-300 rounded-3xl p-2 items-center">
                    
                    <!-- Plus/Image Menu -->
                    <div class="relative flex items-center">
                        <!-- Plus Button - Now acts as Image Mode Toggle -->
                        <button id="plus-btn" onclick="toggleImageMode()" title="Toggle Image Mode" class="text-gray-600 p-1 rounded-full hover:bg-gray-100 transition duration-150">
                            <span id="plus-icon" class="material-symbols-outlined text-2xl">add</span>
                        </button>
                    </div>

                    <!-- Text Area -->
                    <textarea id="user-input" class="flex-grow p-1 border-none outline-none resize-none focus:ring-0" placeholder="Ask anything" rows="1" oninput="autoResizeTextarea(this); handleInput(this);" onkeydown="handleKey(event)"></textarea>

                    <!-- Send Button -->
                    <button id="send-btn" onclick="sendMessage()" title="Send Message" class="text-gray-600 p-1 rounded-full hover:bg-gray-100 transition duration-150 disabled:text-gray-400 disabled:hover:bg-white" disabled>
                        <span class="material-symbols-outlined text-2xl">send</span>
                    </button>
                </div>
                
                <!-- Footer Text -->
                <p class="text-xs text-gray-400 mt-2 text-center">
                    Pollinated may display inaccurate information, including about people, so double-check its responses.
                </p>
            </div>
        </div>

    </div>
    
    <!-- Info Box (Slides out from the right when clicking Pollinated title) -->
    <div id="info-box" class="slide-out-box p-6 flex flex-col">
        <div class="flex justify-between items-center mb-6 border-b pb-4">
            <h2 class="text-xl font-bold text-blue-700 flex items-center">
                <span class="material-symbols-outlined mr-2">info</span> About Pollinated
            </h2>
            <button onclick="closeInfoBox()" class="text-gray-500 hover:text-gray-900 transition duration-150">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>
        <p class="text-sm text-gray-700 mb-4">
            This is Pollinated, a demonstration chatbot utilizing external generative AI services.
        </p>
        <ul class="list-disc list-inside text-xs text-gray-600 space-y-2">
            <li><span class="font-semibold">Creator:</span> Created and designed by<code class="bg-gray-200 rounded px-1">Aurora</code>.</li>
            <li><span class="font-semibold">Text Generation:</span> Calls external API from various<code class="bg-gray-200 rounded px-1">LLM's</code>.</li>
            <li><span class="font-semibold">Image Generation:</span> Calls external API at <code class="bg-gray-200 rounded px-1">https://image.pollinations.ai/prompt/</code></li>
            <li><span class="font-semibold">History:</span> Doesn't store user chat history.</li>
            <li><span class="font-semibold">Compatibility:</span> Designed for static hosting environments like GitHub Pages.</li>
        </ul>
        <div class="mt-auto pt-6 border-t">
            <p class="text-xs text-gray-500">App Version 1.5 - Aurora (GitHub Compatible)</p>
        </div>
    </div>

    <!-- Modal for showing messages/errors (Simplified) -->
    <div id="modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm">
            <h3 id="modal-title" class="text-lg font-semibold mb-4 flex items-center">
                <span class="material-symbols-outlined mr-2 text-blue-600" id="modal-icon">info</span>
                <span id="modal-title-text">Information</span>
            </h3>
            <p id="modal-message" class="text-gray-700"></p>
            <div class="mt-6 text-right">
                <button onclick="closeModal()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition duration-150">
                    OK
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- Configuration & Constants ---
        // Direct API calls (CORS must be handled by the API provider)
        const TEXT_API = 'https://text.pollinations.ai/';
        const IMAGE_API = 'https://image.pollinations.ai/prompt/';
        
        // --- State Variables ---
        let chatHistory = []; 
        let isSending = false;
        let isImageMode = false;
        let isChatVisible = false;
        let currentTypingAnimation = null;

        // --- DOM Elements ---
        const chatHistoryEl = document.getElementById('chat-history');
        const userInputEl = document.getElementById('user-input');
        const sendBtnEl = document.getElementById('send-btn');
        const loadingIndicatorEl = document.getElementById('loading-indicator');
        const modalEl = document.getElementById('modal');
        const modalTitleEl = document.getElementById('modal-title-text');
        const modalIconEl = document.getElementById('modal-icon');
        const modalMessageEl = document.getElementById('modal-message');
        const welcomeMessageEl = document.getElementById('welcome-message');
        const mainWelcomeTitleEl = document.getElementById('main-welcome-title'); 
        const welcomeLoaderEl = document.getElementById('welcome-loader');
        const plusIconEl = document.getElementById('plus-btn').querySelector('span');
        const chatMainContentEl = document.getElementById('chat-main-content');
        const infoBoxEl = document.getElementById('info-box');

        // --- Utility Functions ---

        /**
         * Generic API fetch with exponential backoff for robustness.
         * The function performs a direct fetch, relying on the target API to handle CORS.
         */
        async function apiCallWithBackoff(url, maxRetries = 3) {
            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const response = await fetch(url);
                    
                    if (!response.ok) {
                        if (attempt < maxRetries - 1) {
                            const delay = Math.pow(2, attempt) * 1000 + Math.random() * 500;
                            console.warn(`API call failed (Attempt ${attempt + 1}/${maxRetries}). Retrying in ${delay.toFixed(0)}ms.`);
                            await new Promise(resolve => setTimeout(resolve, delay));
                            continue;
                        }
                        throw new Error(`API failed with status ${response.status}: ${response.statusText}. URL: ${url}`);
                    }
                    return response;
                } catch (error) {
                    if (attempt < maxRetries - 1) {
                        const delay = Math.pow(2, attempt) * 1000 + Math.random() * 500;
                        console.error(`Fetch error (Attempt ${attempt + 1}/${maxRetries}):`, error.message);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    }
                    // Throw the original error if max retries are reached
                    throw error;
                }
            }
        }

        /**
         * Simple function for displaying system messages. (Replaces alert/confirm)
         */
        function openModal(title, message, isError = false) {
            modalTitleEl.textContent = title;
            modalMessageEl.textContent = message;
            
            // Set icon and color based on type
            modalIconEl.textContent = isError ? 'warning' : 'info';
            modalIconEl.classList.toggle('text-red-600', isError);
            modalIconEl.classList.toggle('text-blue-600', !isError);
            
            modalEl.classList.remove('hidden');
            modalEl.classList.add('flex');
        }

        function closeModal() {
            modalEl.classList.remove('flex');
            modalEl.classList.add('hidden');
        }

        function updateUIState(sending) {
            isSending = sending;
            userInputEl.disabled = sending;
            sendBtnEl.disabled = sending || userInputEl.value.trim() === '';
            loadingIndicatorEl.classList.toggle('hidden', !sending);
            
            document.getElementById('plus-btn').disabled = sending;
        }
        
        function handleInput(el) {
            sendBtnEl.disabled = isSending || el.value.trim() === '';
        }

        function handleKey(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                if (!sendBtnEl.disabled) {
                    sendMessage();
                }
            }
            handleInput(userInputEl);
        }

        function autoResizeTextarea(el) {
            el.style.height = 'auto';
            el.style.height = (el.scrollHeight) + 'px';
        }

        function scrollToBottom() {
            chatHistoryEl.scrollTop = chatHistoryEl.scrollHeight;
        }
        
        /**
         * Copies text to the clipboard using the modern Clipboard API.
         */
        function copyToClipboard(button, text) {
            if (!text) return;
            
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => {
                    const originalIcon = button.innerHTML;
                    button.innerHTML = '<span class="material-symbols-outlined text-base text-green-500">done</span>';
                    setTimeout(() => {
                        button.innerHTML = originalIcon;
                    }, 2000);
                }).catch(err => {
                    console.error("Failed to copy text: ", err);
                    openModal("Copy Failed", "Could not automatically copy text to clipboard.", true);
                });
            } else {
                 openModal("Clipboard Unavailable", "Your browser does not support automatic clipboard copying. Please copy manually.", true);
            }
        }

        // --- UI Rendering ---
        function displayMessage(message) {
            chatHistory.push(message); 

            const isUser = message.sender === 'user';
            const color = isUser ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-800';
            const role = isUser ? 'You' : 'Pollinated';

             const messageWrapper = document.createElement('div');
            // User message wrapper aligns to the right edge (justify-end).
            // Bot message wrapper aligns to the left edge (justify-start).
            messageWrapper.className = `flex w-full ${isUser ? 'justify-end' : 'justify-start'}`;
            
            const contentContainer = document.createElement('div');
            // User content aligns right. Bot content aligns left. The inner message bubble still limits width.
            contentContainer.className = `${isUser ? 'flex flex-col items-end' : 'flex flex-col items-start'}`;

            const messageBubble = document.createElement('div');
            // All message bubbles are limited to max-w-xl for optimal text line length.
            messageBubble.className = `max-w-xl p-3 rounded-xl shadow-sm ${color}`;

            const roleHeader = document.createElement('p');
            roleHeader.className = `font-semibold text-sm mb-1 ${isUser ? 'text-blue-200' : 'text-gray-500'}`;
            roleHeader.textContent = role;
            messageBubble.appendChild(roleHeader);

            let contentToCopy = '';

            if (message.type === 'text') {
                const contentText = document.createElement('p');
                contentText.className = 'whitespace-pre-wrap';
                
                if (!isUser && message.content) {
                    // Bot message: prepare for typing animation
                    contentText.textContent = '';
                    const cursorSpan = document.createElement('span');
                    cursorSpan.className = 'typing-cursor';
                    contentText.appendChild(cursorSpan);
                    
                    messageBubble.typingElement = contentText;
                    messageBubble.fullContent = message.content;
                } else {
                    // User messages or error messages display immediately
                    contentText.textContent = message.content;
                    contentToCopy = message.content;
                }
                
                messageBubble.appendChild(contentText);

            } else if (message.type === 'image') {
                const imageEl = document.createElement('img');
                imageEl.src = message.content;
                imageEl.alt = 'Generated Image';
                imageEl.className = 'rounded-lg w-full h-auto object-cover mt-2 max-h-96';
                imageEl.onerror = () => {
                    imageEl.remove();
                    const errorMsg = document.createElement('p');
                    errorMsg.textContent = "Image failed to load. The API might have returned an invalid image or URL.";
                    errorMsg.className = 'text-red-500 text-sm mt-2';
                    messageBubble.appendChild(errorMsg);
                };
                messageBubble.appendChild(imageEl);

                const caption = document.createElement('p');
                caption.textContent = `Prompt: "${message.caption}"`;
                caption.className = 'text-xs mt-2 italic opacity-80';
                messageBubble.appendChild(caption);
                contentToCopy = message.caption; // Copy the prompt for images
            }
            
            contentContainer.appendChild(messageBubble);

            // Add Copy Button for Bot Messages
            if (!isUser) {
                const actionRow = document.createElement('div');
                actionRow.className = 'flex items-center space-x-2 mt-1 px-1';

                const copyButton = document.createElement('button');
                copyButton.className = 'text-gray-500 hover:text-blue-600 transition duration-150 p-1 rounded-full text-xs';
                copyButton.innerHTML = '<span class="material-symbols-outlined text-base">content_copy</span>';
                copyButton.title = "Copy to clipboard";
                
                // Set the function to copy the text content or image prompt
                copyButton.onclick = () => {
                    // Ensure we copy the final full text if animation is ongoing
                    const textToCopy = message.type === 'text' && messageBubble.fullContent 
                        ? messageBubble.fullContent 
                        : contentToCopy;
                    copyToClipboard(copyButton, textToCopy);
                };
                
                actionRow.appendChild(copyButton);
                contentContainer.appendChild(actionRow);
            }

            messageWrapper.appendChild(contentContainer);
            chatHistoryEl.appendChild(messageWrapper);

            // Once the first message is displayed, switch to chat view
            if (!isChatVisible) {
                welcomeMessageEl.classList.add('hidden');
                chatHistoryEl.classList.remove('hidden');
                chatMainContentEl.classList.remove('justify-center', 'items-center');
                chatMainContentEl.classList.add('justify-start', 'items-start');
                isChatVisible = true;
            }

            scrollToBottom();
            
            // If this is a bot text message, start the typing animation
            if (!isUser && message.type === 'text' && message.content) {
                startTypingAnimation(messageBubble);
            }
        }

        /**
         * Animate text appearing word by word with a maximum of 1 second total
         */
        function startTypingAnimation(messageBubble) {
            if (currentTypingAnimation) {
                clearTimeout(currentTypingAnimation);
            }
            
            const textElement = messageBubble.typingElement;
            const fullText = messageBubble.fullContent;
            
            if (!textElement || !fullText) return;
            
            const words = fullText.split(/\s+/);
            const totalWords = words.length;
            
            // Calculate delay per word to ensure a smooth, quick animation
            const maxTotalTime = 1000; 
            const delayPerWord = Math.min(maxTotalTime / totalWords, 100); 
            
            let currentWordIndex = 0;
            
            function typeNextWord() {
                if (currentWordIndex < totalWords) {
                    const cursor = textElement.querySelector('.typing-cursor');
                    if (cursor) cursor.remove();
                    
                    if (currentWordIndex > 0) {
                        textElement.textContent += ' ';
                    }
                    textElement.textContent += words[currentWordIndex];
                    
                    const newCursor = document.createElement('span');
                    newCursor.className = 'typing-cursor';
                    textElement.appendChild(newCursor);
                    
                    currentWordIndex++;
                    currentTypingAnimation = setTimeout(typeNextWord, delayPerWord);
                    scrollToBottom();
                } else {
                    const cursor = textElement.querySelector('.typing-cursor');
                    if (cursor) cursor.remove();
                    currentTypingAnimation = null;
                }
            }
            
            currentTypingAnimation = setTimeout(typeNextWord, delayPerWord);
        }


        // --- API Call Logic ---

        async function fetchTextResponse(prompt) {
            const encodedPrompt = encodeURIComponent(prompt);
            const url = `${TEXT_API}${encodedPrompt}`;

            const response = await apiCallWithBackoff(url);
            const text = await response.text();
            
            const trimmedText = text.trim();
            if (trimmedText.length === 0) {
                 throw new Error("Received empty response from text API.");
            }
            
            return trimmedText;
        }

        async function fetchImageResponse(prompt) {
            const encodedPrompt = encodeURIComponent(prompt);
            // The image API directly returns the image on the URL
            return `${IMAGE_API}${encodedPrompt}`; 
        }

        // --- Feature Functions ---

        async function fetchWelcomeMessage() {
            welcomeLoaderEl.classList.remove('hidden');

            // Use hardcoded greetings to avoid making unnecessary API calls on load
            const greetings = [
    "Hello! How can I help?",
    "Hi there! Ready to chat?",
    "Welcome! What can I do for you?",
    "Hey! How's your day going?",
    "Greetings! What would you like to know?",
    "Good day! How may I assist you?",
    "Hello there! What's on your mind?",
    "Hi! I'm here to help.",
    "Welcome back! How can I assist?",
    "Hey there! What brings you here?",
    "Hello! Ready to explore?",
    "Hi! Let's chat!",
    "Greetings! Ask me anything.",
    "Hey! What can I do for you today?",
    "Hello! How can I be of service?",
    "Hi! I'm all ears.",
    "Welcome! Let's get started.",
    "Hey there! Need some help?",
    "Hello! What would you like to discuss?",
    "Hi! I'm here and ready.",
    "Greetings! How can I assist?",
    "Hey! What's new with you?",
    "Hello! How's everything going?",
    "Hi there! Let's have a conversation.",
    "Welcome! I'm here to help.",
    "Hey! What's on your mind today?",
    "Hello! Feel free to ask anything.",
    "Hi! I'm excited to help you.",
    "Greetings! What questions do you have?",
    "Hey there! How can I support you?",
    "Hello! Let's make today productive.",
    "Hi! I'm ready when you are.",
    "Welcome! What shall we talk about?",
    "Hey! I'm here to answer questions.",
    "Hello! How can I make your day better?",
    "Hi there! Let's brainstorm together.",
    "Greetings! I'm at your service.",
    "Hey! What would you like to know?",
    "Hello! I'm happy to assist you.",
    "Hi! Let's dive into conversation.",
    "Welcome! I'm here to chat.",
    "Hey there! How can I be useful?",
    "Hello! What topic interests you?",
    "Hi! Ready for our conversation?",
    "Greetings! Let's explore ideas.",
    "Hey! I'm here to help you learn.",
    "Hello! How can I assist today?",
    "Hi there! Let's start chatting.",
    "Welcome! I'm ready to help.",
    "Hey! What shall we discuss?",
    "Hello! I'm here to provide answers.",
    "Hi! Let's have a productive chat.",
    "Greetings! How may I help you?",
    "Hey there! What can I explain?",
    "Hello! I'm here to guide you.",
    "Hi! Ready to answer your questions.",
    "Welcome! Let's begin our conversation.",
    "Hey! How can I assist you now?",
    "Hello! I'm eager to help.",
    "Hi there! Let's talk!",
    "Greetings! What would you like to ask?",
    "Hey! I'm here to share knowledge.",
    "Hello! How can I support your day?",
    "Hi! Let's have a great conversation.",
    "Welcome! I'm ready to chat with you.",
    "Hey there! What's your question?",
    "Hello! I'm here to provide information.",
    "Hi! Let's make this chat valuable.",
    "Greetings! How can I be helpful?",
    "Hey! Ready to assist you.",
    "Hello! What would you like to explore?",
    "Hi there! I'm here to respond.",
    "Welcome! Let's have an engaging chat.",
    "Hey! How can I make you smile?",
    "Hello! I'm here to listen and help.",
    "Hi! Let's start our discussion.",
    "Greetings! What's on your agenda?",
    "Hey there! How can I brighten your day?",
    "Hello! I'm ready to converse.",
    "Hi! Let's have an interesting talk.",
    "Welcome! What would you like to know today?",
    "Hey! I'm here to provide insights.",
    "Hello! How can I be of assistance?",
    "Hi there! Let's begin our dialogue.",
    "Greetings! I'm excited to chat with you.",
    "Hey! What topic shall we cover?",
    "Hello! I'm here to answer queries.",
    "Hi! Let's have a meaningful conversation.",
    "Welcome! How can I help you now?",
    "Hey there! I'm ready to assist.",
    "Hello! What would you like to learn?",
    "Hi! Let's explore together.",
    "Greetings! I'm here to support you.",
    "Hey! How can I contribute today?",
    "Hello! I'm available to help.",
    "Hi there! Let's have a productive talk.",
    "Welcome! What's your question?",
    "Hey! I'm here to provide guidance.",
    "Hello! Let's make this conversation count.",
    "Hi! Ready to help you succeed.",
    "Greetings! How can I serve you today?",
    "Hey there! I'm here to chat with you.",
    "Hello! What shall we discover together?"
];
                
            const randomGreeting = greetings[Math.floor(Math.random() * greetings.length)];
            mainWelcomeTitleEl.textContent = randomGreeting;
                
            welcomeLoaderEl.classList.add('hidden');
        }
        
        function openInfoBox() {
            infoBoxEl.classList.add('open');
        }

        function closeInfoBox() {
            infoBoxEl.classList.remove('open');
        }

        function updateImageModeUI() {
            plusIconEl.textContent = isImageMode ? 'image' : 'add';
            plusIconEl.classList.toggle('text-blue-600', isImageMode);
            plusIconEl.classList.toggle('text-gray-600', !isImageMode);
        }

        function toggleImageMode() {
            isImageMode = !isImageMode;
            updateImageModeUI();

            // Update the input placeholder
            userInputEl.placeholder = isImageMode ? 
                "Describe the image you want to generate..." : 
                "Ask anything";
        }

        // --- Main Chat Logic ---

        async function sendMessage() {
            if (isSending) return;

            const prompt = userInputEl.value.trim();
            if (!prompt) return;

            updateUIState(true);

            // 1. Display User Message
            displayMessage({ sender: 'user', content: prompt, type: 'text' });
            userInputEl.value = ''; // Clear input immediately
            autoResizeTextarea(userInputEl); // Reset textarea height

            try {
                if (isImageMode) {
                    // 2. Handle Image Generation
                    const imageUrl = await fetchImageResponse(prompt);
                    displayMessage({ sender: 'bot', content: imageUrl, type: 'image', caption: prompt });
                } else {
                    // 3. Handle Text Generation
                    const textResponse = await fetchTextResponse(prompt);
                    displayMessage({ sender: 'bot', content: textResponse, type: 'text' });
                }
            } catch (error) {
                console.error("API call error:", error);
                
                // Stop any running typing animation
                if (currentTypingAnimation) {
                    clearTimeout(currentTypingAnimation);
                    currentTypingAnimation = null;
                }

                // Display error message in chat history as a bot message
                displayMessage({ 
                    sender: 'bot', 
                    content: `ðŸ¤– Error: Failed to get response. This is likely due to CORS restrictions or the external API being down. Details: ${error.message.substring(0, 100)}...`, 
                    type: 'text' 
                });
                
                openModal("API Communication Error", 
                    `There was an issue communicating with the external API (${error.message}). ` + 
                    `Please check if the API supports CORS for your static hosting environment.`, 
                    true
                );

            } finally {
                updateUIState(false);
            }
        }

        // --- Initialization ---

        function initialize() {
            updateImageModeUI();
            
            // Fetch the welcome message on initialization
            fetchWelcomeMessage();

            userInputEl.addEventListener('input', () => handleInput(userInputEl));
            sendBtnEl.disabled = userInputEl.value.trim() === '';
            userInputEl.rows = 1;
        }

        // Initialize the application
        initialize();
    </script>
</body>
</html>
