<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pollinated by Aurora (Multi-Chat)</title>
    <!-- Load Tailwind CSS from CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Google Material Symbols from CDN -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Symbols+Outlined" rel="stylesheet">
    <style>
        /* Define Inter font for a clean look */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        /* Default CSS Variables (Blue Theme) */
        :root {
            --primary-color: #1D4ED8; /* Blue-600 */
            --primary-hover: #3B82F6; /* Blue-500 */
            --bg-primary: #FFFFFF;
            --bg-bot-bubble: #F3F4F6;
            --text-color: #1F2937; /* Gray-800 */
            --text-secondary: #6B7280; /* Gray-500 */
            --border-color: #E5E7EB; /* Gray-200 */
            --bg-header: #FFFFFF;
            --input-border: #D1D5DB;
            --bg-gradient-stop: #EBF8FF; /* Light blue stop for gradient */
        }

        body {
            font-family: 'Inter', sans-serif;
            /* Apply gradient background to the entire body */
            background-color: var(--bg-primary); 
            background-image: linear-gradient(180deg, var(--bg-primary) 0%, var(--bg-gradient-stop) 100%);
            transition: background-color 0.3s ease, background-image 0.3s ease;
        }

        /* Custom scrollbar for chat history */
        #chat-history, #chat-list-container {
            scrollbar-width: thin;
            scrollbar-color: var(--primary-color) #f3f4f6;
        }
        #chat-history::-webkit-scrollbar,
        #chat-list-container::-webkit-scrollbar {
            width: 8px;
        }
        #chat-history::-webkit-scrollbar-track,
        #chat-list-container::-webkit-scrollbar-track {
            background: transparent; /* Use transparent to show gradient */
        }
        #chat-history::-webkit-scrollbar-thumb,
        #chat-list-container::-webkit-scrollbar-thumb {
            background-color: var(--text-secondary);
            border-radius: 20px;
            border: 3px solid var(--bg-primary);
        }
        
        /* Style for the loading spinner */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border-left-color: var(--primary-color); /* Dynamic color */
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Input specific styles for modern look */
        #input-wrapper {
            box-shadow: 0 1px 6px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            transition: box-shadow 0.3s;
            align-items: center;
            border-color: var(--input-border);
            background-color: var(--bg-primary);
        }
        #input-wrapper:focus-within {
             box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
             border-color: var(--primary-color);
        }
        #user-input {
            padding-top: 8px; 
            padding-bottom: 8px;
            line-height: 1.5;
            color: var(--text-color);
            background-color: transparent;
        }
        #user-input::placeholder {
            color: var(--text-secondary);
        }

        /* Slide-out Panels (Both) */
        .slide-out-box {
            position: fixed;
            top: 0;
            width: 100%;
            max-width: 350px;
            height: 100%;
            transition: transform 0.3s ease-in-out, box-shadow 0.3s;
            z-index: 50; 
            background-color: var(--bg-primary);
            color: var(--text-color);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        /* Settings Panel (Right) */
        #settings-panel {
            right: 0;
            transform: translateX(100%);
            border-left: 1px solid var(--border-color); 
        }
        #settings-panel.open {
            transform: translateX(0);
            box-shadow: -4px 0 10px rgba(0, 0, 0, 0.1);
        }
        
        /* Chats Panel (Left) - NEW */
        #chats-panel {
            left: 0;
            transform: translateX(-100%);
            border-right: 1px solid var(--border-color); 
        }
        #chats-panel.open {
            transform: translateX(0);
            box-shadow: 4px 0 10px rgba(0, 0, 0, 0.1);
        }
        
        /* Dropdown Menu for chat items - NEW */
        .chat-item-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background-color: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            z-index: 60;
            width: 120px;
            display: none; /* Hidden by default */
        }
        
        /* Typing cursor animation */
        .typing-cursor {
            display: inline-block;
            width: 2px;
            height: 1em;
            background-color: currentColor;
            margin-left: 2px;
            animation: blink 1s infinite;
            vertical-align: middle;
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }
    </style>
</head>
<body class="w-screen min-h-screen flex flex-col overflow-x-hidden">

    <!-- Main Content Area -->
    <div class="flex-grow flex flex-col h-full relative">
        
        <!-- Header -->
        <header class="p-4 border-b border-[--border-color] flex justify-between items-center flex-shrink-0 bg-[--bg-header]">
            <!-- Chats Button (NEW) -->
            <button onclick="openChatsPanel()" title="Chats" class="text-[--text-secondary] p-2 rounded-full hover:bg-[--bg-bot-bubble] transition duration-150">
                <span class="material-symbols-outlined text-2xl">chevron_right</span>
            </button>
            
            <!-- Title -->
            <h1 class="text-xl font-semibold text-[--text-color] flex items-center">
                Pollinated
            </h1>
            
            <!-- Settings Button -->
            <button onclick="openSettingsPanel()" title="Settings" class="text-[--text-secondary] p-2 rounded-full hover:bg-[--bg-bot-bubble] transition duration-150">
                <span class="material-symbols-outlined text-2xl">settings</span>
            </button>
        </header>

        <!-- Chat Main Area -->
        <main id="chat-main-content" class="flex-grow overflow-y-auto p-4 flex flex-col justify-center items-center">
            
            <!-- Welcome Screen (Initial State) -->
            <div id="welcome-message" class="text-center transition-opacity duration-300 p-8 max-w-lg">
                <!-- Friendly default message -->
                <h1 id="main-welcome-title" class="text-4xl md:text-5xl font-extrabold text-[--text-color] mb-6">Hello! How can I help you today?</h1>
                <div id="welcome-loader" class="spinner mx-auto hidden"></div>
            </div>

            <!-- Chat History Area -->
            <div id="chat-history" classs="hidden" class="flex-grow w-full px-4 pt-16 space-y-6 overflow-y-auto">
                <!-- Chat messages will be injected here -->
            </div>
        </main>
        
        <!-- Input Area (Fixed to Bottom, Centered) -->
        <div class="w-full flex justify-center py-4 bg-[--bg-header] flex-shrink-0 border-t border-[--border-color]">
            <div id="input-container" class="w-full max-w-3xl px-4">
                <div id="loading-indicator" class="hidden text-center py-2">
                    <div class="spinner mx-auto"></div>
                    <p class="text-sm text-[--text-secondary] mt-1">AI is thinking...</p>
                </div>

                <!-- Text Input and Send Button -->
                <div id="input-wrapper" class="flex space-x-2 bg-[--bg-primary] border rounded-3xl p-2 items-center">
                    
                    <!-- Plus/Image Menu (Now Message/Image Toggle) -->
                    <div class="relative flex items-center">
                        <button id="plus-btn" onclick="toggleImageMode()" title="Toggle Image/Text Mode" class="text-[--text-secondary] p-1 rounded-full hover:bg-[--bg-bot-bubble] transition duration-150">
                            <span id="plus-icon" class="material-symbols-outlined text-2xl">forum</span>
                        </button>
                    </div>

                    <!-- Text Area -->
                    <textarea id="user-input" class="flex-grow p-1 border-none outline-none resize-none focus:ring-0" placeholder="Ask anything" rows="1" oninput="autoResizeTextarea(this); handleInput(this);" onkeydown="handleKey(event)"></textarea>

                    <!-- Send Button -->
                    <button id="send-btn" onclick="sendMessage()" title="Send Message" class="text-[--text-secondary] p-1 rounded-full hover:bg-[--bg-bot-bubble] transition duration-150 disabled:text-[--text-secondary] disabled:opacity-50 disabled:hover:bg-transparent" disabled>
                        <span class="material-symbols-outlined text-2xl">send</span>
                    </button>
                </div>
                
                <!-- Footer Text -->
                <p class="text-xs text-[--text-secondary] mt-2 text-center">
                    Pollinated may display inaccurate information, including about people, so double-check its responses.
                </p>
            </div>
        </div>

    </div>

    <!-- Chats Panel (Slides out from the left) - NEW -->
    <div id="chats-panel" class="slide-out-box p-4 flex flex-col">
        <div class="flex justify-between items-center mb-4 border-b pb-3 border-[--border-color]">
            <h2 class="text-xl font-bold text-[--primary-color] flex items-center">
                <span class="material-symbols-outlined mr-2">chat</span> Chats
            </h2>
            <button onclick="closeChatsPanel()" class="text-[--text-secondary] hover:text-[--text-color] transition duration-150">
                <span class="material-symbols-outlined">chevron_left</span>
            </button>
        </div>

        <!-- New Chat Button -->
        <button onclick="startNewChat()" class="w-full bg-[--primary-color] text-white px-4 py-2 rounded-lg hover:bg-[--primary-hover] transition duration-150 flex items-center justify-center mb-4">
            <span class="material-symbols-outlined text-base mr-2">add</span>
            New Chat
        </button>

        <!-- Search Chats -->
        <div class="relative mb-4">
            <input type="search" id="chat-search-input" oninput="handleSearch(this.value)" placeholder="Search chats..." class="w-full p-2 pl-8 border border-[--input-border] rounded-lg bg-[--bg-primary] text-[--text-color] focus:ring-2 focus:ring-[--primary-color] focus:outline-none">
            <span class="material-symbols-outlined absolute left-2 top-1/2 -translate-y-1/2 text-[--text-secondary]">search</span>
        </div>

        <!-- Chat List -->
        <div id="chat-list-container" class="flex-grow overflow-y-auto space-y-2">
            <!-- Chat items will be injected here -->
        </div>
    </div>
    
    <!-- Settings Panel (Slides out from the right) -->
    <div id="settings-panel" class="slide-out-box p-6 flex flex-col">
        <div class="flex justify-between items-center mb-6 border-b pb-4 border-[--border-color]">
            <h2 class="text-xl font-bold text-[--primary-color] flex items-center">
                <span class="material-symbols-outlined mr-2">tune</span> Settings & Info
            </h2>
            <button onclick="closeSettingsPanel()" class="text-[--text-secondary] hover:text-[--text-color] transition duration-150">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>

        <!-- Theme Selector -->
        <section class="mb-8 pb-4 border-b border-[--border-color]">
            <h3 class="text-lg font-semibold text-[--text-color] mb-3">Choose Theme</h3>
            <div id="theme-selector" class="grid grid-cols-3 gap-3">
                <!-- Theme Buttons injected by JS -->
            </div>
        </section>

        <!-- Save Location (NEW) -->
        <section class="mb-8 pb-4 border-b border-[--border-color]">
            <h3 class="text-lg font-semibold text-[--text-color] mb-3 flex items-center">
                <span class="material-symbols-outlined mr-2 text-base">save</span>
                Save Location
            </h3>
            <p class="text-sm text-[--text-secondary] mb-4">
                Choose where to save your chat history.
            </p>
            <div class="space-y-2">
                <label class="flex items-center p-3 rounded-lg border border-[--border-color] hover:bg-[--bg-bot-bubble]">
                    <input type="radio" name="save-location" value="browser" onclick="setSaveLocation('browser')" class="text-[--primary-color] focus:ring-[--primary-color]">
                    <span class="ml-3 text-[--text-color]">
                        <strong class="block">Browser</strong>
                        <span class="text-xs text-[--text-secondary]">Saves to this browser's local storage.</span>
                    </span>
                </label>
                <label class="flex items-center p-3 rounded-lg border border-[--border-color] hover:bg-[--bg-bot-bubble]">
                    <input type="radio" name="save-location" value="device" onclick="setSaveLocation('device')" class="text-[--primary-color] focus:ring-[--primary-color]">
                    <span class="ml-3 text-[--text-color]">
                        <strong class="block">Device</strong>
                        <span class="text-xs text-[--text-secondary]">Saves to a folder on your device. (Requires permissions)</span>
                    </span>
                </label>
            </div>
            <div id="device-save-status" class="mt-3">
                <!-- Status for file system handle will go here -->
            </div>
        </section>

        <!-- General Info -->
        <section>
            <h3 class="text-lg font-semibold text-[--text-color] mb-3">About Pollinated</h3>
            <p class="text-sm text-[--text-secondary] mb-4">
                This is pollinated, an AI chat window powered by pollinations.ai. Pollinations is used for all services acquired by DocuWrite Pro.
            </p>
        </section>

        <div class="mt-auto pt-6 border-t border-[--border-color]">
            <p class="text-xs text-[--text-secondary]">App Version 2.0 - Multi-Chat</p>
        </div>
    </div>

    <!-- Modal for showing messages/errors (Simplified) -->
    <div id="modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center p-4 z-[100]">
        <div class="bg-[--bg-primary] p-6 rounded-xl shadow-2xl w-full max-w-sm">
            <h3 id="modal-title" class="text-lg font-semibold mb-4 flex items-center text-[--text-color]">
                <span class="material-symbols-outlined mr-2 text-[--primary-color]" id="modal-icon">info</span>
                <span id="modal-title-text">Information</span>
            </h3>
            <p id="modal-message" class="text-[--text-color]"></p>
            
            <!-- Modal input (for rename) - NEW -->
            <input type="text" id="modal-input" class="hidden w-full p-2 mt-4 border border-[--input-border] rounded-lg bg-[--bg-primary] text-[--text-color] focus:ring-2 focus:ring-[--primary-color] focus:outline-none" />
            
            <div class="mt-6 flex justify-end space-x-3">
                <button id="modal-cancel-btn" onclick="closeModal()" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 transition duration-150 hidden">
                    Cancel
                </button>
                <button id="modal-ok-btn" onclick="closeModal()" class="bg-[--primary-color] text-white px-4 py-2 rounded-lg hover:bg-[--primary-hover] transition duration-150">
                    OK
                </button>
            </div>
        </div>
    </div>

    <!-- Global Click Listener for closing menus -->
    <div id="global-overlay" class="fixed inset-0 z-40 hidden" onclick="closeAllPopups()"></div>

    <script>
        // --- Configuration & Constants ---
        const TEXT_API = 'https://text.pollinations.ai/';
        const IMAGE_API = 'https://image.pollinations.ai/prompt/';

        const THEMES = {
            blue: { primary: '#1D4ED8', secondary: '#3B82F6', bgPrimary: '#FFFFFF', bgBot: '#F3F4F6', text: '#1F2937', textSecondary: '#6B7280', border: '#E5E7EB', bgHeader: '#FFFFFF', inputBorder: '#D1D5DB', bgGradientStop: '#EBF8FF' },
            red: { primary: '#DC2626', secondary: '#EF4444', bgPrimary: '#FFFFFF', bgBot: '#FEE2E2', text: '#1F2937', textSecondary: '#6B7280', border: '#FCA5A5', bgHeader: '#FFFFFF', inputBorder: '#F87171', bgGradientStop: '#FFF1F2' },
            green: { primary: '#059669', secondary: '#10B981', bgPrimary: '#FFFFFF', bgBot: '#D1FAE5', text: '#1F2937', textSecondary: '#6B7280', border: '#A7F3D0', bgHeader: '#FFFFFF', inputBorder: '#4ADE80', bgGradientStop: '#F0FFF4' },
            yellow: { primary: '#D97706', secondary: '#F59E0B', bgPrimary: '#FFFFFF', bgBot: '#FEF3C7', text: '#1F2937', textSecondary: '#6B7280', border: '#FCD34D', bgHeader: '#FFFFFF', inputBorder: '#FBBF24', bgGradientStop: '#FFFBEB' },
            white: { primary: '#374151', secondary: '#6B7280', bgPrimary: '#FFFFFF', bgBot: '#F3F4F6', text: '#1F2937', textSecondary: '#6B7280', border: '#E5E7EB', bgHeader: '#FFFFFF', inputBorder: '#D1D5DB', bgGradientStop: '#F9FAFB' },
            black: { primary: '#9CA3AF', secondary: '#D1D5DB', bgPrimary: '#111827', bgBot: '#374151', text: '#F9FAFB', textSecondary: '#D1D5DB', border: '#374151', bgHeader: '#1F2937', inputBorder: '#4B5563', bgGradientStop: '#1F2937' },
        };
        
        // --- State Variables ---
        let allChats = {}; // Object to store all chat histories
        let currentChatId = null; // ID of the currently active chat
        let saveLocation = 'browser'; // 'browser' or 'device'
        let fileSystemHandle = null; // For File System Access API
        
        let isSending = false;
        let isImageMode = false;
        let isChatVisible = false;
        let currentTypingAnimation = null;
        let currentTheme = 'blue';

        // --- DOM Elements ---
        const chatHistoryEl = document.getElementById('chat-history');
        const userInputEl = document.getElementById('user-input');
        const sendBtnEl = document.getElementById('send-btn');
        const loadingIndicatorEl = document.getElementById('loading-indicator');
        const modalEl = document.getElementById('modal');
        const modalTitleEl = document.getElementById('modal-title-text');
        const modalIconEl = document.getElementById('modal-icon');
        const modalMessageEl = document.getElementById('modal-message');
        const modalInputEl = document.getElementById('modal-input');
        const modalOkBtn = document.getElementById('modal-ok-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        const welcomeMessageEl = document.getElementById('welcome-message');
        const mainWelcomeTitleEl = document.getElementById('main-welcome-title'); 
        const welcomeLoaderEl = document.getElementById('welcome-loader');
        const plusIconEl = document.getElementById('plus-btn').querySelector('span');
        const chatMainContentEl = document.getElementById('chat-main-content');
        const settingsPanelEl = document.getElementById('settings-panel');
        const chatsPanelEl = document.getElementById('chats-panel'); // NEW
        const chatListContainerEl = document.getElementById('chat-list-container'); // NEW
        const deviceSaveStatusEl = document.getElementById('device-save-status'); // NEW
        const globalOverlayEl = document.getElementById('global-overlay');

        // --- Theme Logic ---
        function applyTheme(themeName) {
            const theme = THEMES[themeName];
            if (!theme) return;

            currentTheme = themeName;
            localStorage.setItem('pollinated_theme', themeName);

            const root = document.documentElement.style;
            root.setProperty('--primary-color', theme.primary);
            root.setProperty('--primary-hover', theme.secondary);
            root.setProperty('--bg-primary', theme.bgPrimary);
            root.setProperty('--bg-bot-bubble', theme.bgBot);
            root.setProperty('--text-color', theme.text);
            root.setProperty('--text-secondary', theme.textSecondary);
            root.setProperty('--border-color', theme.border);
            root.setProperty('--bg-header', theme.bgHeader);
            root.setProperty('--input-border', theme.inputBorder);
            root.setProperty('--bg-gradient-stop', theme.bgGradientStop);

            document.body.style.backgroundColor = theme.bgPrimary;
            document.body.style.backgroundImage = `linear-gradient(180deg, ${theme.bgPrimary} 0%, ${theme.bgGradientStop} 100%)`;
            
            highlightActiveThemeButton(themeName);
        }

        function highlightActiveThemeButton(activeTheme) {
            const buttons = document.querySelectorAll('#theme-selector button');
            buttons.forEach(btn => {
                if (btn.dataset.theme === activeTheme) {
                    btn.classList.add('ring-4', 'ring-offset-2', 'ring-offset-[--bg-primary]');
                } else {
                    btn.classList.remove('ring-4', 'ring-offset-2', 'ring-offset-[--bg-primary]');
                }
            });
        }

        function createThemeButtons() {
            const selector = document.getElementById('theme-selector');
            selector.innerHTML = '';
            Object.keys(THEMES).forEach(themeName => {
                const theme = THEMES[themeName];
                const button = document.createElement('button');
                button.dataset.theme = themeName;
                button.title = themeName.charAt(0).toUpperCase() + themeName.slice(1);
                button.className = `p-4 rounded-xl shadow-md transition duration-150 hover:opacity-90 ring-[${theme.primary}]`;
                button.style.backgroundColor = theme.primary;
                
                let textColor = 'white';
                if (themeName === 'yellow') textColor = THEMES.blue.primary;
                if (themeName === 'white') textColor = THEMES.blue.primary;
                if (themeName === 'black') textColor = THEMES.blue.secondary;
                
                button.innerHTML = `<span class="text-sm font-bold capitalize" style="color: ${textColor}">${themeName}</span>`;

                button.onclick = () => {
                    applyTheme(themeName);
                };
                selector.appendChild(button);
            });
        }

        // --- History & Chat Management (HEAVILY REFACTORED) ---

        /**
         * Saves all chats to the chosen location (browser or device).
         */
        async function saveChats() {
            if (saveLocation === 'browser') {
                try {
                    localStorage.setItem('pollinated_chats', JSON.stringify(allChats));
                } catch (e) {
                    console.error("Failed to save chats to localStorage:", e);
                    openModal("Save Error", "Could not save chats to browser storage. It might be full.", true);
                }
            } else if (saveLocation === 'device') {
                if (!fileSystemHandle) {
                    console.warn("Save to device skipped: No directory handle.");
                    return; // Don't warn the user every single time, only on setup
                }
                try {
                    // Save each chat as a separate file
                    for (const chatId in allChats) {
                        const chat = allChats[chatId];
                        const fileName = `${chatId}.json`;
                        const fileHandle = await fileSystemHandle.getFileHandle(fileName, { create: true });
                        const writable = await fileHandle.createWritable();
                        await writable.write(JSON.stringify(chat));
                        await writable.close();
                    }
                    // Clean up deleted chats from device
                    for await (const entry of fileSystemHandle.values()) {
                        if (entry.kind === 'file' && entry.name.endsWith('.json')) {
                            const chatId = entry.name.replace('.json', '');
                            if (!allChats[chatId]) {
                                await fileSystemHandle.removeEntry(entry.name);
                            }
                        }
                    }
                } catch (e) {
                    console.error("Failed to save chats to device:", e);
                    openModal("Save Error", `Could not save chats to device: ${e.message}`, true);
                }
            }
        }

        /**
         * Loads all chats from the chosen location.
         */
        async function loadChats() {
            saveLocation = localStorage.getItem('pollinated_save_location') || 'browser';
            document.querySelector(`input[name='save-location'][value='${saveLocation}']`).checked = true;

            if (saveLocation === 'browser') {
                try {
                    const chatsJson = localStorage.getItem('pollinated_chats');
                    allChats = chatsJson ? JSON.parse(chatsJson) : {};
                } catch (e) {
                    console.error("Failed to load chats from localStorage:", e);
                    allChats = {};
                }
            } else if (saveLocation === 'device') {
                allChats = {};
                // We cannot auto-load from device due to security restrictions.
                // We must ask the user to select the directory again if the handle is lost.
                updateDeviceSaveStatus(false, "Click to select chat folder.");
            }
            
            // After loading chats, get the last active chat ID
            currentChatId = localStorage.getItem('pollinated_current_chat_id');
            
            if (!currentChatId || !allChats[currentChatId]) {
                // If no valid last chat, start a new one
                startNewChat(false); // 'false' to prevent recursive save
            } else {
                // Load the last active chat
                loadChat(currentChatId);
            }
            
            // Render the list
            renderChatList();
        }
        
        /**
         * Creates a new, empty chat and sets it as active.
         * @param {boolean} doSave - Whether to immediately save the new chat list (default: true)
         */
        function startNewChat(doSave = true) {
            const newChatId = `chat_${Date.now()}`;
            allChats[newChatId] = {
                name: "New Chat",
                messages: []
            };
            
            currentChatId = newChatId;
            localStorage.setItem('pollinated_current_chat_id', currentChatId);
            
            // Clear the UI
            chatHistoryEl.innerHTML = '';
            showWelcomeScreen(true);
            
            if (doSave) {
                saveChats();
            }
            
            renderChatList();
            closeChatsPanel();
        }

        /**
         * Loads a specific chat's history into the main view.
         * @param {string} chatId - The ID of the chat to load.
         */
        function loadChat(chatId) {
            if (!allChats[chatId]) {
                console.warn(`Chat ${chatId} not found. Starting new chat.`);
                startNewChat();
                return;
            }
            
            currentChatId = chatId;
            localStorage.setItem('pollinated_current_chat_id', currentChatId);
            
            const chat = allChats[chatId];
            chatHistoryEl.innerHTML = ''; // Clear current view
            
            if (chat.messages.length > 0) {
                chat.messages.forEach(msg => {
                    displayMessage(msg, true); // 'true' for loading (no animation)
                });
                showWelcomeScreen(false);
            } else {
                showWelcomeScreen(true);
            }
            
            renderChatList(); // To highlight the new active chat
            closeChatsPanel();
        }
        
        /**
         * Deletes a chat from memory and storage.
         * @param {string} chatId - The ID of the chat to delete.
         */
        function deleteChat(chatId) {
            if (!allChats[chatId]) return;
            
            const chatName = allChats[chatId].name;
            
            openModalWithConfirm(
                "Delete Chat?",
                `Are you sure you want to permanently delete the chat "${chatName}"?`,
                "Delete",
                () => {
                    delete allChats[chatId];
                    
                    if (currentChatId === chatId) {
                        // If we deleted the active chat, start a new one
                        startNewChat(false); // Don't save yet
                    }
                    
                    saveChats(); // Now save the deletion
                    renderChatList();
                }
            );
        }
        
        /**
         * Renames a chat.
         * @param {string} chatId - The ID of the chat to rename.
         */
        function renameChat(chatId) {
             if (!allChats[chatId]) return;
             
             const oldName = allChats[chatId].name;
             
             openModalWithInput(
                "Rename Chat",
                "Enter a new name for this chat:",
                oldName,
                (newName) => {
                    if (newName && newName.trim() !== "") {
                        allChats[chatId].name = newName.trim();
                        saveChats();
                        renderChatList();
                    }
                }
             );
        }
        
        /**
         * Renders the list of chats in the side panel.
         * @param {string} [searchTerm] - Optional filter for chat names.
         */
        function renderChatList(searchTerm = "") {
            chatListContainerEl.innerHTML = '';
            const lowerSearchTerm = searchTerm.toLowerCase();
            
            const chatIds = Object.keys(allChats);
            // Sort to show newest first
            chatIds.sort((a, b) => b.split('_')[1] - a.split('_')[1]);
            
            let foundChats = false;
            
            chatIds.forEach(chatId => {
                const chat = allChats[chatId];
                if (chat.name.toLowerCase().includes(lowerSearchTerm)) {
                    foundChats = true;
                    const item = document.createElement('div');
                    item.className = `relative p-3 rounded-lg flex justify-between items-center group ${currentChatId === chatId ? 'bg-[--bg-bot-bubble]' : 'hover:bg-[--bg-bot-bubble]'}`;
                    
                    const nameButton = document.createElement('button');
                    nameButton.className = 'flex-grow text-left truncate text-sm text-[--text-color]';
                    nameButton.textContent = chat.name;
                    nameButton.onclick = () => loadChat(chatId);
                    
                    const optionsButton = document.createElement('button');
                    optionsButton.className = 'flex-shrink-0 p-1 rounded-full text-[--text-secondary] hover:bg-gray-300 opacity-0 group-hover:opacity-100 transition-opacity';
                    optionsButton.innerHTML = '<span class="material-symbols-outlined text-base">more_horiz</span>';
                    optionsButton.onclick = (e) => {
                        e.stopPropagation();
                        toggleChatMenu(e.currentTarget, chatId);
                    };
                    
                    item.appendChild(nameButton);
                    item.appendChild(optionsButton);
                    chatListContainerEl.appendChild(item);
                }
            });
            
            if (!foundChats) {
                 chatListContainerEl.innerHTML = `<p class="text-sm text-center text-[--text-secondary] p-4">No chats found.</p>`;
            }
        }
        
        /**
         * Toggles the little rename/delete menu for a chat item.
         */
        function toggleChatMenu(buttonEl, chatId) {
            // Close any existing menus
            closeAllPopups();
            
            const menu = document.createElement('div');
            menu.className = 'chat-item-menu';
            menu.style.display = 'block';
            
            menu.innerHTML = `
                <button class="flex items-center w-full px-3 py-2 text-sm text-left text-[--text-color] hover:bg-[--bg-bot-bubble]" onclick="event.stopPropagation(); renameChat('${chatId}');">
                    <span class="material-symbols-outlined text-base mr-2">edit</span> Rename
                </button>
                <button class="flex items-center w-full px-3 py-2 text-sm text-left text-red-600 hover:bg-[--bg-bot-bubble]" onclick="event.stopPropagation(); deleteChat('${chatId}');">
                    <span class="material-symbols-outlined text-base mr-2">delete</span> Delete
                </button>
            `;
            
            // Position menu relative to the button's parent (the chat item)
            buttonEl.parentElement.appendChild(menu);
            globalOverlayEl.style.display = 'block'; // Show overlay
        }
        
        function handleSearch(value) {
            renderChatList(value);
        }

        // --- Save Location Logic (NEW) ---

        /**
         * Sets the save location and triggers permission request if needed.
         */
        async function setSaveLocation(location) {
            if (location === saveLocation) return;
            
            if (location === 'device') {
                if (!('showDirectoryPicker' in window)) {
                    openModal("Unsupported Browser", "Your browser does not support the File System Access API. Cannot save to device.", true);
                    document.querySelector(`input[name='save-location'][value='browser']`).checked = true;
                    return;
                }
                
                try {
                    fileSystemHandle = await window.showDirectoryPicker();
                    // We have the handle, now ask to migrate
                    openModalWithConfirm(
                        "Migrate Chats?",
                        "Do you want to copy your current browser chats to this new folder? (This will not remove them from the browser)",
                        "Copy",
                        async () => {
                            saveLocation = 'device'; // Set location *before* saving
                            localStorage.setItem('pollinated_save_location', 'device');
                            await saveChats(); // This will save all 'allChats' (from browser) to device
                            updateDeviceSaveStatus(true);
                        },
                        () => {
                            saveLocation = 'device';
                            localStorage.setItem('pollinated_save_location', 'device');
                            allChats = {}; // Start fresh on device
                            startNewChat();
                            updateDeviceSaveStatus(true);
                        }
                    );
                } catch (e) {
                    // User cancelled picker or error
                    console.error("Directory picker error:", e);
                    document.querySelector(`input[name='save-location'][value='browser']`).checked = true;
                    return;
                }
                
            } else if (location === 'browser') {
                // Migrating from device to browser
                openModalWithConfirm(
                    "Migrate Chats?",
                    "Do you want to copy your chats from the device to the browser? This will merge them with existing browser chats.",
                    "Copy",
                    async () => {
                        // At this point, 'allChats' holds device chats.
                        // Load browser chats, merge, then save to browser.
                        const browserChatsJson = localStorage.getItem('pollinated_chats');
                        const browserChats = browserChatsJson ? JSON.parse(browserChatsJson) : {};
                        const mergedChats = { ...browserChats, ...allChats };
                        
                        allChats = mergedChats;
                        saveLocation = 'browser';
                        localStorage.setItem('pollinated_save_location', 'browser');
                        fileSystemHandle = null;
                        await saveChats();
                        renderChatList();
                        updateDeviceSaveStatus();
                    },
                    () => {
                        // Just switch to browser, don't copy
                        saveLocation = 'browser';
                        localStorage.setItem('pollinated_save_location', 'browser');
                        fileSystemHandle = null;
                        loadChats(); // Reload from browser
                        updateDeviceSaveStatus();
                    }
                );
            }
        }
        
        /**
         * Loads chats from a user-selected device folder.
         */
        async function loadFromDeviceFolder() {
            if (!('showDirectoryPicker' in window)) {
                openModal("Unsupported Browser", "Your browser does not support the File System Access API.", true);
                return;
            }
            try {
                fileSystemHandle = await window.showDirectoryPicker();
                allChats = {};
                for await (const entry of fileSystemHandle.values()) {
                    if (entry.kind === 'file' && entry.name.endsWith('.json')) {
                        const file = await entry.getFile();
                        const content = await file.text();
                        const chatId = entry.name.replace('.json', '');
                        try {
                            allChats[chatId] = JSON.parse(content);
                        } catch (e) {
                            console.warn(`Could not parse chat file ${entry.name}`, e);
                        }
                    }
                }
                updateDeviceSaveStatus(true);
                
                // After loading, find the most recent chat to display
                const chatIds = Object.keys(allChats);
                if (chatIds.length > 0) {
                     chatIds.sort((a, b) => b.split('_')[1] - a.split('_')[1]);
                     currentChatId = chatIds[0];
                } else {
                    startNewChat(false); // No chats found, start a new one
                }
                
                localStorage.setItem('pollinated_current_chat_id', currentChatId);
                loadChat(currentChatId);
                renderChatList();
                
            } catch (e) {
                console.error("Failed to load from device folder:", e);
                updateDeviceSaveStatus(false, "Failed to load folder.");
            }
        }
        
        /**
         * Updates the status message in the settings panel for device saving.
         */
        function updateDeviceSaveStatus(connected = false, message = "") {
            if (saveLocation !== 'device') {
                deviceSaveStatusEl.innerHTML = '';
                return;
            }
            
            if (connected || fileSystemHandle) {
                deviceSaveStatusEl.innerHTML = `
                    <div class="text-sm text-green-600 flex items-center">
                        <span class="material-symbols-outlined text-base mr-1">folder_managed</span>
                        Saving to: <strong>${fileSystemHandle.name}</strong>
                    </div>`;
            } else {
                 deviceSaveStatusEl.innerHTML = `
                    <button onclick="loadFromDeviceFolder()" class="w-full text-sm text-[--primary-color] hover:underline">
                        ${message || "Click to select chat folder."}
                    </button>`;
            }
        }

        // --- Utility Functions ---

        async function apiCallWithBackoff(url, maxRetries = 3) {
            // (Implementation unchanged from previous version)
            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`API failed with status ${response.status}`);
                    return response;
                } catch (error) {
                    if (attempt < maxRetries - 1) {
                        const delay = Math.pow(2, attempt) * 1000 + Math.random() * 500;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    }
                    throw error;
                }
            }
        }

        function openModal(title, message, isError = false) {
            modalTitleEl.textContent = title;
            modalMessageEl.textContent = message;
            modalIconEl.textContent = isError ? 'warning' : 'info';
            modalIconEl.style.color = isError ? THEMES.red.primary : THEMES[currentTheme].primary;
            
            modalInputEl.classList.add('hidden');
            modalOkBtn.textContent = 'OK';
            modalCancelBtn.classList.add('hidden');
            
            modalOkBtn.onclick = closeModal;
            
            modalEl.classList.remove('hidden');
            modalEl.classList.add('flex');
        }
        
        function openModalWithConfirm(title, message, okText, okCallback, cancelCallback = null) {
            openModal(title, message, false);
            
            modalOkBtn.textContent = okText;
            modalCancelBtn.classList.remove('hidden');
            
            modalOkBtn.onclick = () => {
                closeModal();
                if (okCallback) okCallback();
            };
            
            modalCancelBtn.onclick = () => {
                closeModal();
                if (cancelCallback) cancelCallback();
            };
        }
        
        function openModalWithInput(title, message, defaultValue, okCallback) {
            openModal(title, message, false);
            
            modalInputEl.value = defaultValue;
            modalInputEl.classList.remove('hidden');
            modalOkBtn.textContent = 'Save';
            modalCancelBtn.classList.remove('hidden');
            
            modalOkBtn.onclick = () => {
                const value = modalInputEl.value;
                closeModal();
                if (okCallback) okCallback(value);
            };
            
            modalCancelBtn.onclick = closeModal;
        }

        function closeModal() {
            modalEl.classList.remove('flex');
            modalEl.classList.add('hidden');
            // Reset modal defaults
            modalInputEl.classList.add('hidden');
            modalCancelBtn.classList.add('hidden');
            modalOkBtn.textContent = 'OK';
            modalOkBtn.onclick = closeModal;
        }
        
        function closeAllPopups() {
            // Close chat item menus
            document.querySelectorAll('.chat-item-menu').forEach(menu => menu.remove());
            // Hide overlay
            globalOverlayEl.style.display = 'none';
        }

        function updateUIState(sending) {
            isSending = sending;
            userInputEl.disabled = sending;
            sendBtnEl.disabled = sending || userInputEl.value.trim() === '';
            loadingIndicatorEl.classList.toggle('hidden', !sending);
            document.getElementById('plus-btn').disabled = sending;
        }
        
        function handleInput(el) {
            sendBtnEl.disabled = isSending || el.value.trim() === '';
        }

        function handleKey(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                if (!sendBtnEl.disabled) {
                    sendMessage();
                }
            }
            handleInput(userInputEl);
        }

        function autoResizeTextarea(el) {
            el.style.height = 'auto';
            el.style.height = (el.scrollHeight) + 'px';
        }

        function scrollToBottom() {
            chatHistoryEl.scrollTop = chatHistoryEl.scrollHeight;
        }
        
        function copyToClipboard(button, text) {
            // (Implementation unchanged from previous version)
            if (!text) return;
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => {
                    const originalIcon = button.innerHTML;
                    button.innerHTML = '<span class="material-symbols-outlined text-base text-green-500">done</span>';
                    setTimeout(() => { button.innerHTML = originalIcon; }, 2000);
                }).catch(err => {
                    openModal("Copy Failed", "Could not automatically copy text to clipboard.", true);
                });
            } else {
                 openModal("Clipboard Unavailable", "Your browser does not support automatic clipboard copying.", true);
            }
        }
        
        function showWelcomeScreen(show) {
             if (show) {
                welcomeMessageEl.classList.remove('hidden');
                chatHistoryEl.classList.add('hidden');
                chatMainContentEl.classList.add('justify-center', 'items-center');
                chatMainContentEl.classList.remove('justify-start', 'items-start');
                isChatVisible = false;
             } else {
                welcomeMessageEl.classList.add('hidden');
                chatHistoryEl.classList.remove('hidden');
                chatMainContentEl.classList.remove('justify-center', 'items-center');
                chatMainContentEl.classList.add('justify-start', 'items-start');
                isChatVisible = true;
             }
        }

        // --- UI Rendering ---
        
        /**
         * Renders a message bubble to the chat history.
         * @param {object} message - The message object.
         * @param {boolean} isLoad - If true, treats the message as loaded (no push, no animation).
         */
        function displayMessage(message, isLoad = false) {
            const isUser = message.sender === 'user';
            
            const userColor = 'bg-[--primary-color] text-white';
            const botColor = 'bg-[--bg-bot-bubble] text-[--text-color]';
            
            const color = isUser ? userColor : botColor;
            const role = isUser ? 'You' : 'Pollinated';

            const messageWrapper = document.createElement('div');
            messageWrapper.className = `flex w-full ${isUser ? 'justify-end' : 'justify-start'}`;
            
            const contentContainer = document.createElement('div');
            contentContainer.className = `${isUser ? 'flex flex-col items-end' : 'flex flex-col items-start'}`;

            const messageBubble = document.createElement('div');
            messageBubble.className = `max-w-xl p-3 shadow-sm ${color} ${isUser ? 'rounded-2xl rounded-tr-md' : 'rounded-2xl rounded-tl-md'}`;

            const roleHeader = document.createElement('p');
            roleHeader.className = `font-semibold text-sm mb-1 ${isUser ? 'text-white/80' : 'text-[--text-secondary]'}`;
            roleHeader.textContent = role;
            messageBubble.appendChild(roleHeader);

            let contentToCopy = '';

            if (message.type === 'text') {
                const contentText = document.createElement('p');
                contentText.className = 'whitespace-pre-wrap';
                
                if (!isUser && message.content && !isLoad) { // Only animate if NOT loading
                    contentText.textContent = '';
                    const cursorSpan = document.createElement('span');
                    cursorSpan.className = 'typing-cursor';
                    contentText.appendChild(cursorSpan);
                    messageBubble.typingElement = contentText;
                    messageBubble.fullContent = message.content;
                } else {
                    contentText.textContent = message.content;
                    contentToCopy = message.content;
                    if (!isUser) messageBubble.fullContent = message.content; 
                }
                messageBubble.appendChild(contentText);

            } else if (message.type === 'image') {
                const imageEl = document.createElement('img');
                imageEl.src = message.content;
                imageEl.alt = 'Generated Image';
                imageEl.className = 'rounded-lg w-full h-auto object-cover mt-2 max-h-96';
                imageEl.onerror = () => {
                    imageEl.remove();
                    const errorMsg = document.createElement('p');
                    errorMsg.textContent = "Image failed to load.";
                    errorMsg.className = 'text-red-500 text-sm mt-2';
                    messageBubble.appendChild(errorMsg);
                };
                messageBubble.appendChild(imageEl);

                const caption = document.createElement('p');
                caption.textContent = `Prompt: "${message.caption}"`;
                caption.className = 'text-xs mt-2 italic opacity-80 text-[--text-secondary]';
                messageBubble.appendChild(caption);
                contentToCopy = message.caption;
            }
            
            contentContainer.appendChild(messageBubble);

            if (!isUser) {
                const actionRow = document.createElement('div');
                actionRow.className = 'flex items-center space-x-2 mt-1 px-1';
                const copyButton = document.createElement('button');
                copyButton.className = 'text-[--text-secondary] hover:text-[--primary-color] transition duration-150 p-1 rounded-full text-xs';
                copyButton.innerHTML = '<span class="material-symbols-outlined text-base">content_copy</span>';
                copyButton.title = "Copy to clipboard";
                
                copyButton.onclick = () => {
                    const textToCopy = message.type === 'text' && messageBubble.fullContent 
                        ? messageBubble.fullContent 
                        : contentToCopy;
                    copyToClipboard(copyButton, textToCopy);
                };
                
                actionRow.appendChild(copyButton);
                contentContainer.appendChild(actionRow);
            }

            messageWrapper.appendChild(contentContainer);
            chatHistoryEl.appendChild(messageWrapper);

            // Once the first message is displayed, switch to chat view
            if (!isChatVisible) {
                showWelcomeScreen(false);
            }

            scrollToBottom();
            
            if (!isLoad && !isUser && message.type === 'text' && message.content) {
                startTypingAnimation(messageBubble);
            }
        }

        function startTypingAnimation(messageBubble) {
            // (Implementation unchanged from previous version)
            if (currentTypingAnimation) clearTimeout(currentTypingAnimation);
            const textElement = messageBubble.typingElement;
            const fullText = messageBubble.fullContent;
            if (!textElement || !fullText) return;
            const words = fullText.split(/\s+/);
            const totalWords = words.length;
            const maxTotalTime = 1000; 
            const delayPerWord = Math.min(maxTotalTime / totalWords, 100); 
            let currentWordIndex = 0;
            
            function typeNextWord() {
                if (currentWordIndex < totalWords) {
                    const cursor = textElement.querySelector('.typing-cursor');
                    if (cursor) cursor.remove();
                    if (currentWordIndex > 0) textElement.textContent += ' ';
                    textElement.textContent += words[currentWordIndex];
                    const newCursor = document.createElement('span');
                    newCursor.className = 'typing-cursor';
                    textElement.appendChild(newCursor);
                    currentWordIndex++;
                    currentTypingAnimation = setTimeout(typeNextWord, delayPerWord);
                    scrollToBottom();
                } else {
                    const cursor = textElement.querySelector('.typing-cursor');
                    if (cursor) cursor.remove();
                    currentTypingAnimation = null;
                }
            }
            currentTypingAnimation = setTimeout(typeNextWord, delayPerWord);
        }

        // --- API Call Logic ---

        async function fetchTextResponse(prompt) {
            const encodedPrompt = encodeURIComponent(prompt);
            const url = `${TEXT_API}${encodedPrompt}`;
            const response = await apiCallWithBackoff(url);
            const text = await response.text();
            const trimmedText = text.trim();
            if (trimmedText.length === 0) throw new Error("Received empty response from text API.");
            return trimmedText;
        }

        async function fetchImageResponse(prompt) {
            const encodedPrompt = encodeURIComponent(prompt);
            return `${IMAGE_API}${encodedPrompt}`; 
        }

        // --- Feature Functions ---
        
        function openSettingsPanel() {
            closeChatsPanel();
            settingsPanelEl.classList.add('open');
            highlightActiveThemeButton(currentTheme); 
            updateDeviceSaveStatus(fileSystemHandle, "Click to select chat folder.");
        }

        function closeSettingsPanel() {
            settingsPanelEl.classList.remove('open');
        }
        
        function openChatsPanel() {
            closeSettingsPanel();
            chatsPanelEl.classList.add('open');
            document.getElementById('chat-search-input').value = ''; // Clear search
            renderChatList(); // Refresh list
        }

        function closeChatsPanel() {
            chatsPanelEl.classList.remove('open');
        }

        async function fetchWelcomeMessage() {
            // (Implementation unchanged from previous version)
            welcomeLoaderEl.classList.remove('hidden');
            const greetings = [
    "Hello! How can I help?",
    "Hi there! Ready to chat?",
    "Welcome! What can I do for you?",
    "Hey! How's your day going?",
    "Greetings! What would you like to know?",
    "Good day! How may I assist you?",
    "Hello there! What's on your mind?",
    "Hi! I'm here to help.",
    "Welcome back! How can I assist?",
    "Hey there! What brings you here?",
    "Hello! Ready to explore?",
    "Hi! Let's chat!",
    "Greetings! Ask me anything.",
    "Hey! What can I do for you today?",
    "Hello! How can I be of service?",
    "Hi! I'm all ears.",
    "Welcome! Let's get started.",
    "Hey there! Need some help?",
    "Hello! What would you like to discuss?",
    "Hi! I'm here and ready.",
    "Greetings! How can I assist?",
    "Hey! What's new with you?",
    "Hello! How's everything going?",
    "Hi there! Let's have a conversation.",
    "Welcome! I'm here to help.",
    "Hey! What's on your mind today?",
    "Hello! Feel free to ask anything.",
    "Hi! I'm excited to help you.",
    "Greetings! What questions do you have?",
    "Hey there! How can I support you?",
    "Hello! Let's make today productive.",
    "Hi! I'm ready when you are.",
    "Welcome! What shall we talk about?",
    "Hey! I'm here to answer questions.",
    "Hello! How can I make your day better?",
    "Hi there! Let's brainstorm together.",
    "Greetings! I'm at your service.",
    "Hey! What would you like to know?",
    "Hello! I'm happy to assist you.",
    "Hi! Let's dive into conversation.",
    "Welcome! I'm here to chat.",
    "Hey there! How can I be useful?",
    "Hello! What topic interests you?",
    "Hi! Ready for our conversation?",
    "Greetings! Let's explore ideas.",
    "Hey! I'm here to help you learn.",
    "Hello! How can I assist today?",
    "Hi there! Let's start chatting.",
    "Welcome! I'm ready to help.",
    "Hey! What shall we discuss?",
    "Hello! I'm here to provide answers.",
    "Hi! Let's have a productive chat.",
    "Greetings! How may I help you?",
    "Hey there! What can I explain?",
    "Hello! I'm here to guide you.",
    "Hi! Ready to answer your questions.",
    "Welcome! Let's begin our conversation.",
    "Hey! How can I assist you now?",
    "Hello! I'm eager to help.",
    "Hi there! Let's talk!",
    "Greetings! What would you like to ask?",
    "Hey! I'm here to share knowledge.",
    "Hello! How can I support your day?",
    "Hi! Let's have a great conversation.",
    "Welcome! I'm ready to chat with you.",
    "Hey there! What's your question?",
    "Hello! I'm here to provide information.",
    "Hi! Let's make this chat valuable.",
    "Greetings! How can I be helpful?",
    "Hey! Ready to assist you.",
    "Hello! What would you like to explore?",
    "Hi there! I'm here to respond.",
    "Welcome! Let's have an engaging chat.",
    "Hey! How can I make you smile?",
    "Hello! I'm here to listen and help.",
    "Hi! Let's start our discussion.",
    "Greetings! What's on your agenda?",
    "Hey there! How can I brighten your day?",
    "Hello! I'm ready to converse.",
    "Hi! Let's have an interesting talk.",
    "Welcome! What would you like to know today?",
    "Hey! I'm here to provide insights.",
    "Hello! How can I be of assistance?",
    "Hi there! Let's begin our dialogue.",
    "Greetings! I'm excited to chat with you.",
    "Hey! What topic shall we cover?",
    "Hello! I'm here to answer queries.",
    "Hi! Let's have a meaningful conversation.",
    "Welcome! How can I help you now?",
    "Hey there! I'm ready to assist.",
    "Hello! What would you like to learn?",
    "Hi! Let's explore together.",
    "Greetings! I'm here to support you.",
    "Hey! How can I contribute today?",
    "Hello! I'm available to help.",
    "Hi there! Let's have a productive talk.",
    "Welcome! What's your question?",
    "Hey! I'm here to provide guidance.",
    "Hello! Let's make this conversation count.",
    "Hi! Ready to help you succeed.",
    "Greetings! How can I serve you today?",
    "Hey there! I'm here to chat with you.",
    "Hello! What shall we discover together?"
];
            const randomGreeting = greetings[Math.floor(Math.random() * greetings.length)];
            mainWelcomeTitleEl.textContent = randomGreeting;
            welcomeLoaderEl.classList.add('hidden');
        }
        
        function updateImageModeUI() {
            plusIconEl.textContent = isImageMode ? 'image' : 'forum'; 
            plusIconEl.classList.toggle('text-[--primary-color]', isImageMode);
            plusIconEl.classList.toggle('text-[--text-secondary]', !isImageMode);
        }

        function toggleImageMode() {
            isImageMode = !isImageMode;
            updateImageModeUI();
            userInputEl.placeholder = isImageMode ? 
                "Describe the image you want to generate..." : 
                "Ask anything";
        }

        // --- Main Chat Logic ---

        async function sendMessage() {
            if (isSending) return;

            const prompt = userInputEl.value.trim();
            if (!prompt) return;

            updateUIState(true);

            // 1. Prepare message objects
            const userMessage = { sender: 'user', content: prompt, type: 'text' };
            
            // 2. Add to state
            const currentChat = allChats[currentChatId];
            if (currentChat.messages.length === 0) {
                // This is the first message, set chat name
                currentChat.name = prompt.substring(0, 40) + (prompt.length > 40 ? "..." : "");
                renderChatList(); // Update list with new name
            }
            currentChat.messages.push(userMessage);

            // 3. Display User Message
            displayMessage(userMessage);
            userInputEl.value = '';
            autoResizeTextarea(userInputEl);

            let botMessage;

            try {
                if (isImageMode) {
                    // 4a. Handle Image Generation
                    const imageUrl = await fetchImageResponse(prompt);
                    botMessage = { sender: 'bot', content: imageUrl, type: 'image', caption: prompt };
                } else {
                    // 4b. Handle Text Generation
                    const textResponse = await fetchTextResponse(prompt);
                    botMessage = { sender: 'bot', content: textResponse, type: 'text' };
                }
                
                // 5. Add bot message to state
                currentChat.messages.push(botMessage);
                displayMessage(botMessage);

            } catch (error) {
                if (currentTypingAnimation) {
                    clearTimeout(currentTypingAnimation);
                    currentTypingAnimation = null;
                }

                // 6. Handle errors
                botMessage = { 
                    sender: 'bot', 
                    content: ` Error: Failed to get response. Details: ${error.message.substring(0, 100)}...`, 
                    type: 'text' 
                };
                currentChat.messages.push(botMessage);
                displayMessage(botMessage);
                
                openModal("API Error", `Issue communicating with the external API: ${error.message}`, true);

            } finally {
                updateUIState(false);
                // 7. Save the entire chat
                saveChats();
            }
        }

        // --- Initialization ---

        async function initialize() {
            // 1. Initialize Theme
            const savedTheme = localStorage.getItem('pollinated_theme') || 'blue';
            applyTheme(savedTheme);
            createThemeButtons();
            
            // 2. Load Chats and settings
            // This function now handles loading chats, save location, and current chat
            await loadChats();

            // 3. Initialize UI
            updateImageModeUI();
            if (allChats[currentChatId] && allChats[currentChatId].messages.length === 0) {
                fetchWelcomeMessage();
            }

            userInputEl.addEventListener('input', () => handleInput(userInputEl));
            sendBtnEl.disabled = userInputEl.value.trim() === '';
            userInputEl.rows = 1;
            
            // Close popups when clicking outside
            document.body.addEventListener('click', (e) => {
                if (!e.target.closest('.chat-item-menu, .group button')) {
                    closeAllPopups();
                }
            });
        }

        // Initialize the application
        initialize();
    </script>
</body>
</html>
